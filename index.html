<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Color Memory Wheel</title>

  <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Protest+Revolution&family=Oleo+Script&display=swap');

:root{
  --text: rgba(255,255,255,.95);
  --muted: rgba(255,255,255,.78);
  --shadow: 0 18px 50px rgba(0,0,0,.45);
  --appScale: 1;
}

*{ box-sizing: border-box; }
html, body{ height: 100%; }

body{
  margin: 0;
  height: 100vh;
  overflow: hidden;
  color: var(--text);
  font-family: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(1200px circle at 20% 10%, rgba(255,255,255,0.18), transparent 60%),
    radial-gradient(900px circle at 80% 0%, rgba(255,0,150,0.16), transparent 65%),
    radial-gradient(900px circle at 80% 60%, rgba(0,255,200,0.12), transparent 60%),
    linear-gradient(180deg, #2a0a2b 0%, #0b1f46 60%, #071226 100%);
}
body::before{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background:
    repeating-linear-gradient(
      135deg,
      rgba(255,47,75,.14) 0px,
      rgba(255,47,75,.14) 26px,
      rgba(255,255,255,.06) 26px,
      rgba(255,255,255,.06) 52px
    );
  mix-blend-mode: overlay;
  opacity: .52;
}

/* ‚úÖ Medium twinkling stars in GAME background */
#stars{
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}
.star{
  position: absolute;
  left: var(--x);
  top: var(--y);
  width: var(--s);
  height: var(--s);
  border-radius: 999px;
  background: rgba(255,255,255,.92);
  box-shadow:
    0 0 10px rgba(255,255,255,.38),
    0 0 26px rgba(140,220,255,.16);
  opacity: .18;
  transform: translate(-50%,-50%) scale(.9);
  animation: starTwinkle var(--t) ease-in-out infinite;
  animation-delay: var(--d);
}
.star::after{
  content:"";
  position:absolute;
  inset:-10px;
  background: radial-gradient(circle, rgba(255,255,255,.12), transparent 70%);
  border-radius: 999px;
}
@keyframes starTwinkle{
  0%,100%{ opacity:.18; transform: translate(-50%,-50%) scale(.85); filter: brightness(.9); }
  50%{ opacity:.95; transform: translate(-50%,-50%) scale(1.12); filter: brightness(1.25); }
}

/* Background balloons */
#balloons{
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}
.balloon{
  position: absolute;
  left: var(--x);
  bottom: -22vh;
  width: var(--w);
  height: var(--w);
  border-radius: 50%;
  background: hsla(var(--h), 85%, 60%, 0.88);
  box-shadow: inset 0 -18px 24px rgba(0,0,0,.18), inset 0 16px 24px rgba(255,255,255,.22);
  filter: drop-shadow(0 16px 18px rgba(0,0,0,.25));
  animation: floatUp var(--t) linear forwards;
  opacity: 0;
}
.balloon::after{
  content:"";
  position: absolute;
  left: 50%;
  bottom: -8px;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 7px solid transparent;
  border-right: 7px solid transparent;
  border-top: 10px solid rgba(255,255,255,.35);
}
.balloon .string{
  position: absolute;
  left: 50%;
  top: calc(100% + 2px);
  transform: translateX(-50%);
  width: 2px;
  height: var(--s);
  background: rgba(255,255,255,.28);
  border-radius: 2px;
  opacity: .9;
}
@keyframes floatUp{
  0%{ transform: translateY(0) rotate(-2deg); opacity: 0; }
  8%{ opacity: .95; }
  100%{ transform: translateY(-140vh) rotate(2deg); opacity: 0; }
}

/* FX layers */
#confetti{
  position: fixed;
  inset: 0;
  z-index: 60;
  pointer-events: none;
}
#fxLayer{
  position: fixed;
  inset: 0;
  z-index: 61;
  pointer-events: none;
}

/* ‚úÖ Auto-fit scale root */
#scaleRoot{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(var(--appScale));
  transform-origin: center;
  z-index: 1;
  width: min(1440px, 98vw);
}

/* App */
.app{
  width: 100%;
  padding: 6px 0;
  display: grid;
  grid-template-rows: 1fr auto;
}
.stage{
  display: grid;
  grid-template-columns:
    clamp(240px, 22vw, 300px)
    1fr
    clamp(360px, 30vw, 520px);
  gap: 12px;
  align-items: start;
  height: calc(100vh - 20px);
  min-height: 0;
}
.leftPanel, .rightPanel{ display: grid; gap: 10px; min-height: 0; }

.panelTitle{
  font-family: "Protest Revolution", "Inter", system-ui;
  font-weight: 400;
  font-size: 20px;
  letter-spacing: .6px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
}

.centerCol{ display: grid; gap: 10px; justify-items: center; min-height: 0; }
.centerHeader{
  text-align: center;
  padding: 10px 12px;
  border-radius: 18px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  width: min(860px, 100%);
}
.centerTitle{
  font-family: "Protest Revolution", "Inter", system-ui;
  font-weight: 400;
  font-size: clamp(26px, 3.0vw, 44px);
  letter-spacing: .6px;
}
.titleWords .w1{
  color: rgba(255,110,220,.98);
  text-shadow: 0 0 12px rgba(255,110,220,.22), 0 12px 28px rgba(0,0,0,.35);
}
.titleWords .w2{
  color: rgba(120,255,240,.98);
  text-shadow: 0 0 12px rgba(120,255,240,.18), 0 12px 28px rgba(0,0,0,.35);
}
.titleWords .w3{
  color: rgba(255,220,150,.98);
  text-shadow: 0 0 12px rgba(255,220,150,.16), 0 12px 28px rgba(0,0,0,.35);
}
.centerSubtitle{ margin-top: 4px; font-weight: 800; color: rgba(255,255,255,.86); letter-spacing: .4px; }
.oneLine{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.hudGrid{ display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.stat{
  padding: 10px;
  border-radius: 16px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(10px);
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
}
.statLabel{ font-size: 12px; color: var(--muted); font-weight: 800; }
.statValue{ font-size: 20px; font-weight: 900; }

.panel{
  padding: 12px;
  border-radius: 18px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  min-height: 0;
}
.status{ font-weight: 800; font-size: 13px; line-height: 1.35; margin-bottom: 10px; }
.rows{ display: grid; gap: 10px; margin-bottom: 10px; }
.row{ display: grid; gap: 7px; }
.rowLabel{ font-size: 12px; color: var(--muted); font-weight: 800; }

.pips{ display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px; }
.pip{
  width: 26px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
}
.pip.slot{ background: rgba(255,255,255,.06); border-style: dashed; box-shadow: none; }
.hint{ font-size: 13px; color: rgba(255,255,255,.80); }

/* Bonus */
.bonusWrap{ margin: 10px 0 8px; display: grid; gap: 8px; }
.bonusLabel{ font-size: 12px; color: rgba(255,255,255,.86); font-weight: 900; }
.bonusBalloons{ display: flex; gap: 12px; flex-wrap: wrap; min-height: 62px; align-items: flex-end; }
.bonusBtn{
  pointer-events: auto;
  cursor: pointer;
  user-select: none;
  border: none;
  color: rgba(255,255,255,.98);
  font-weight: 1000;
  box-shadow: 0 14px 26px rgba(0,0,0,.24);
  transition: transform .12s ease, filter .12s ease, opacity .18s ease;
}
.bonusBtn:hover{ filter: brightness(1.10); transform: translateY(-2px) scale(1.02); }
.bonusBtn:active{ transform: translateY(-1px) scale(1.00); }
.bonusBtn.pop{ opacity: 0; transform: scale(.7); pointer-events: none; }

/* Circle balloon = +SECONDS */
.bonusBalloonCircle{
  position: relative;
  width: 84px;
  height: 84px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.26);
  background:
    radial-gradient(circle at 30% 22%, rgba(255,255,255,.58), rgba(255,255,255,0) 44%),
    hsla(var(--h), 85%, 60%, 0.96);
  box-shadow: inset 0 -16px 18px rgba(0,0,0,.18), 0 14px 26px rgba(0,0,0,.24), 0 0 18px hsla(var(--h), 90%, 60%, .24);
  display: grid;
  place-items: center;
  padding: 0;
  text-shadow: 0 10px 20px rgba(0,0,0,.35);
}
.bonusBalloonCircle::after{
  content:"";
  position: absolute;
  left: 50%;
  bottom: -8px;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 9px solid transparent;
  border-right: 9px solid transparent;
  border-top: 12px solid rgba(255,255,255,.28);
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.22));
}
.bonusBalloonCircle .string{
  position: absolute;
  left: 50%;
  bottom: -34px;
  transform: translateX(-50%);
  width: 2px;
  height: 40px;
  background: rgba(255,255,255,.30);
  border-radius: 2px;
}
.bonusBalloonCircle .big{ font-size: 18px; letter-spacing: .2px; }
.bonusBalloonCircle .small{ margin-top: 2px; font-size: 10px; letter-spacing: .9px; opacity: .92; }

/* Ticket shape = +TICKET */
.bonusTicket{
  position: relative;
  width: 118px;
  height: 54px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.26);
  background:
    radial-gradient(circle at 20% 25%, rgba(255,255,255,.40), rgba(255,255,255,0) 44%),
    linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
  box-shadow: inset 0 -14px 18px rgba(0,0,0,.18), 0 14px 26px rgba(0,0,0,.24);
  display: grid;
  place-items: center;
  padding: 0 10px;
  overflow: hidden;
}
.bonusTicket::before,
.bonusTicket::after{
  content:"";
  position: absolute;
  top: 50%;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background: rgba(0,0,0,.24);
  border: 1px solid rgba(255,255,255,.10);
  transform: translateY(-50%);
}
.bonusTicket::before{ left: -12px; }
.bonusTicket::after{ right: -12px; }
.bonusTicket .ticketInner{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  letter-spacing: .5px;
  text-shadow: 0 10px 20px rgba(0,0,0,.35);
}
.bonusTicket .ticketIcon{
  font-size: 18px;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.22));
}

/* ‚úÖ Wheel */
.wheelWrap{
  position: relative;
  width: min(1120px, 78vh, 60vw);
  aspect-ratio: 1;
  margin: 0 auto;
  border-radius: 22px;
  padding: 16px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
}
.pointer{
  position: absolute;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 16px solid transparent;
  border-right: 16px solid transparent;
  border-bottom: 28px solid rgba(255,255,255,.95);
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
  z-index: 8;
}
.rotator{
  width: 100%;
  height: 100%;
  border-radius: 999px;
  overflow: hidden;
  display: grid;
  place-items: center;
  transition: transform 3600ms cubic-bezier(.18,.88,.1,1);
}
#wheelSvg{ width: 100%; height: 100%; display: block; filter: drop-shadow(0 18px 22px rgba(0,0,0,.35)); }
.slice{
  stroke: rgba(255,255,255,.22);
  stroke-width: 2;
  cursor: pointer;
  transition: opacity 140ms ease, stroke-width 140ms ease, filter 160ms ease;
  filter: drop-shadow(0 0 8px color-mix(in srgb, var(--glow) 70%, transparent));
}
.slice:hover{
  filter:
    drop-shadow(0 0 12px color-mix(in srgb, var(--glow) 85%, transparent))
    drop-shadow(0 0 22px color-mix(in srgb, var(--glow) 55%, transparent));
}
.sliceDim{ opacity: .18; }
@keyframes whiteBorderFlash{
  0%{ opacity:1; stroke: rgba(255,255,255,.65); stroke-width:2; filter: drop-shadow(0 0 10px var(--glow)); }
  35%{ opacity:1; stroke: rgba(255,255,255,1); stroke-width:14; filter: drop-shadow(0 0 26px var(--glow)) drop-shadow(0 0 42px var(--glow)); }
  100%{ opacity:1; stroke: rgba(255,255,255,.65); stroke-width:2; filter: drop-shadow(0 0 10px var(--glow)); }
}
.slice.flash{ animation: whiteBorderFlash 520ms ease-in-out both; }

/* Lights around wheel */
.wheelLights{
  position: absolute;
  inset: 8px;
  border-radius: 999px;
  pointer-events: none;
  z-index: 7;
}
.wheelBulb{
  position: absolute;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  background: rgba(255,255,255,.92);
  box-shadow: 0 0 12px rgba(255,255,255,.78), 0 0 22px rgba(255,255,255,.38);
  opacity: .92;
  animation: wheelTwinkle 2.4s ease-in-out infinite;
  animation-delay: var(--d);
}
@keyframes wheelTwinkle{
  0%,100%{ transform: translate(-50%,-50%) scale(1); opacity: .88; filter: brightness(.95); }
  50%{ transform: translate(-50%,-50%) scale(1.10); opacity: 1; filter: brightness(1.25); }
}

/* Center hourglass */
.centerOverlay{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  pointer-events: none;
  z-index: 9;
}
.centerGlass{
  width: 150px;
  height: 150px;
  border-radius: 999px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 18px 40px rgba(0,0,0,.35);
  backdrop-filter: blur(10px);
  display: grid;
  place-items: center;
  gap: 6px;
}
.hg{ width: 74px; height: 74px; }
.hgGlass{ fill: rgba(255,255,255,.06); stroke: rgba(255,255,255,.82); stroke-width: 3; }
.hgSand{ fill: rgba(255, 221, 120, .95); }
.hgNeck{ stroke: rgba(255,255,255,.9); stroke-width: 4; stroke-linecap: round; }
.timerText{ font-weight: 900; font-size: 14px; color: rgba(255,255,255,.95); }

/* Chips */
.shopChip{
  padding: 8px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
  border: 1px dashed rgba(255,255,255,.18);
  font-weight: 900;
}
.shopChip .k{ color: rgba(255,255,255,.78); }

/* Toys list */
.allToysGrid{
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 0;
}
.toyMini{
  border-radius: 16px;
  padding: 10px 10px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 10px 26px rgba(0,0,0,.18);
  display: grid;
  grid-template-columns: 44px 1fr auto;
  gap: 10px;
  align-items: center;
}
.toyMiniEmoji{
  width: 44px;
  height: 44px;
  border-radius: 14px;
  display: grid;
  place-items: center;
  font-size: 26px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
}
.toyMiniMid{ display: grid; gap: 2px; min-width: 0; }
.toyMiniName{
  font-weight: 1000;
  font-size: 12px;
  line-height: 1.1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.toyMiniDesc{
  font-size: 11px;
  line-height: 1.2;
  color: rgba(255,255,255,.78);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.toyMiniRight{ display: grid; gap: 6px; justify-items: end; }
.toyMiniCost{
  font-weight: 1000;
  font-size: 11px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
  border: 1px dashed rgba(255,255,255,.16);
  white-space: nowrap;
}
.toyMiniOwned{
  display: inline-flex;
  justify-self: end;
  font-size: 10px;
  font-weight: 1000;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(120,255,190,.12);
  border: 1px solid rgba(120,255,190,.22);
  color: rgba(210,255,235,.95);
}

/* Buttons */
.btn{
  border: 1px dashed rgba(255,255,255,.28);
  background: rgba(255,255,255,.10);
  color: var(--text);
  padding: 10px 14px;
  border-radius: 14px;
  cursor: pointer;
  box-shadow: 0 10px 25px rgba(0,0,0,.22);
  transition: transform .12s ease, filter .12s ease, opacity .12s ease;
  user-select: none;
  font-weight: 900;
}
.btn:hover{ filter: brightness(1.10); }
.btn:active{ transform: translateY(1px) scale(.99); }
.btn:disabled{ opacity: .40; cursor: not-allowed; filter: none; }
.btn.primary{
  background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
  border-color: rgba(255,255,255,.34);
}
.bigBtn{ width: 100%; padding: 14px 16px; font-size: 15px; }

.glowBtn{ position: relative; overflow: hidden; }
.glowBtn::after{
  content:"";
  position: absolute;
  inset: -60px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%);
  transform: translateX(-40%);
  animation: sheen 2.2s ease-in-out infinite;
  pointer-events: none;
}
@keyframes sheen{
  0%{ transform: translateX(-60%); opacity: .35; }
  50%{ opacity: .8; }
  100%{ transform: translateX(60%); opacity: .35; }
}

/* Modals */
.modal{
  position: fixed;
  inset: 0;
  z-index: 50;
  display: grid;
  place-items: center;
  background: rgba(0,0,0,.60);
  backdrop-filter: blur(7px);
  padding: 18px;
}
.modal.hidden{ display: none; }
.modal.show{ display: grid; }
.modalCard{
  width: min(560px, 92vw);
  border-radius: 20px;
  padding: 18px;
  background: rgba(0,0,0,.30);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.modalCard.wide{ width: min(980px, 94vw); overflow: hidden; }

.modalTitle{
  margin: 0 0 4px 0;
  font-family: "Protest Revolution", "Inter", system-ui;
  font-size: clamp(26px, 3.4vw, 40px);
  font-weight: 400;
  text-align: center;
  letter-spacing: .7px;
}
.modalSub{
  margin: 0 0 14px 0;
  color: rgba(255,255,255,.82);
  font-weight: 900;
  text-align: center;
}
.modalNav{
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 6px;
}
.hiddenPage{ display: none; }

/* ‚úÖ WELCOME: Night Market Neon + Fiesta flags + twinkling lights */
.welcomeWrap{ text-align: center; display: grid; gap: 14px; }

.nmHero{
  position: relative;
  border-radius: 22px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,.16);
  background:
    radial-gradient(900px circle at 50% 0%, rgba(255,255,255,.16), transparent 55%),
    radial-gradient(900px circle at 15% 40%, rgba(255,170,60,.14), transparent 60%),
    radial-gradient(900px circle at 85% 40%, rgba(255,0,170,.12), transparent 60%),
    linear-gradient(180deg, rgba(6,10,30,.62), rgba(0,0,0,.20));
  box-shadow: 0 20px 70px rgba(0,0,0,.48);
  overflow: hidden;
}

/* subtle moving glow */
.nmHero::before{
  content:"";
  position:absolute; inset:-60px;
  background:
    radial-gradient(circle at 20% 30%, rgba(0,255,220,.18), transparent 45%),
    radial-gradient(circle at 80% 35%, rgba(255,70,200,.18), transparent 48%),
    radial-gradient(circle at 55% 10%, rgba(255,220,120,.16), transparent 45%);
  opacity: .9;
  animation: nmGlow 6.5s ease-in-out infinite;
  pointer-events:none;
}
@keyframes nmGlow{
  0%,100%{ transform: translate3d(-18px,-6px,0) scale(1.02); opacity:.75; }
  50%{ transform: translate3d(18px,10px,0) scale(1.05); opacity:1; }
}

/* twinkling lights layer */
.twinkleLayer{
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 1;
}
.twDot{
  position: absolute;
  left: var(--x);
  top: var(--y);
  width: 7px;
  height: 7px;
  border-radius: 999px;
  background: rgba(255,235,200,.95);
  box-shadow:
    0 0 10px rgba(255,220,140,.40),
    0 0 22px rgba(255,220,140,.22);
  opacity: .15;
  transform: scale(.85);
  animation: twinkle var(--t) ease-in-out infinite;
  animation-delay: var(--d);
}
@keyframes twinkle{
  0%,100%{ opacity:.18; transform: scale(.78); filter: brightness(.9); }
  50%{ opacity:1; transform: scale(1.12); filter: brightness(1.25); }
}

/* sparkles */
.sparkles{
  position:absolute;
  inset:0;
  pointer-events:none;
  z-index: 1;
}
.sparkle{
  position:absolute;
  left: var(--x);
  top: var(--y);
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,.85);
  box-shadow: 0 0 12px rgba(255,255,255,.35);
  opacity: .0;
  animation: sparklePop var(--t) ease-in-out infinite;
  animation-delay: var(--d);
}
@keyframes sparklePop{
  0%{ transform: scale(.4); opacity:0; }
  20%{ opacity:.95; }
  50%{ transform: scale(1.1); opacity:.7; }
  100%{ transform: scale(.6); opacity:0; }
}

/* flags */
.flagRow{
  position: relative;
  z-index: 2;
  display: grid;
  gap: 8px;
  margin-bottom: 10px;
}
.flagString{
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 10px 18px rgba(0,0,0,.18);
  opacity: .9;
}
.flags{
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap: 8px;
}
.flag{
  width: 30px;
  height: 28px;
  clip-path: polygon(0 0, 100% 0, 50% 100%);
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.40), rgba(255,255,255,0) 44%),
    hsla(var(--h), 92%, 60%, .98);
  border: 1px solid rgba(255,255,255,.20);
  box-shadow: 0 10px 18px rgba(0,0,0,.26), 0 0 18px hsla(var(--h), 90%, 60%, .16);
  transform-origin: 50% 0%;
  animation: flagWiggle 1.7s ease-in-out infinite;
  animation-delay: var(--d);
}
@keyframes flagWiggle{
  0%,100%{ transform: rotate(-3deg) translateY(0); }
  50%{ transform: rotate(3deg) translateY(1px); }
}

/* neon sign */
.neonSign{
  position: relative;
  z-index: 2;
  border-radius: 22px;
  padding: 16px 14px 14px;
  margin: 6px auto 10px;
  width: min(520px, 100%);
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.16);
  box-shadow:
    0 18px 55px rgba(0,0,0,.45),
    0 0 0 2px rgba(255,255,255,.06) inset;
  overflow: hidden;
}
.neonSign::before{
  content:"";
  position:absolute; inset:-120px;
  background: radial-gradient(circle at 30% 35%, rgba(255,120,40,.16), transparent 52%),
              radial-gradient(circle at 75% 35%, rgba(255,0,200,.14), transparent 54%),
              radial-gradient(circle at 50% 10%, rgba(0,255,220,.12), transparent 52%);
  animation: neonWash 5.4s ease-in-out infinite;
  pointer-events:none;
}
@keyframes neonWash{
  0%,100%{ transform: translateX(-18px) translateY(-8px); opacity:.8; }
  50%{ transform: translateX(18px) translateY(8px); opacity:1; }
}
.neonKicker{
  font-weight: 900;
  letter-spacing: .9px;
  color: rgba(255,255,255,.86);
  text-transform: uppercase;
  font-size: 12px;
}
.neonTitle{
  margin: 6px 0 0;
  font-family: "Protest Revolution", "Inter", system-ui;
  font-weight: 400;
  font-size: clamp(30px, 4.6vw, 50px);
  line-height: 1.05;
  letter-spacing: .7px;
  text-shadow: 0 18px 35px rgba(0,0,0,.55);
}
.neonTitle .w1{
  color: rgba(255,110,220,.95);
  text-shadow: 0 0 10px rgba(255,100,210,.45), 0 0 22px rgba(255,100,210,.25), 0 18px 35px rgba(0,0,0,.55);
  animation: neonFlicker 3.2s ease-in-out infinite;
}
.neonTitle .w2{
  color: rgba(120,255,240,.95);
  text-shadow: 0 0 10px rgba(110,255,240,.35), 0 0 22px rgba(110,255,240,.22), 0 18px 35px rgba(0,0,0,.55);
}
.neonTitle .w3{
  color: rgba(255,220,150,.95);
  text-shadow: 0 0 10px rgba(255,220,150,.30), 0 0 22px rgba(255,220,150,.18), 0 18px 35px rgba(0,0,0,.55);
}
@keyframes neonFlicker{
  0%,100%{ filter: brightness(1); }
  6%{ filter: brightness(1.2); }
  8%{ filter: brightness(.88); }
  10%{ filter: brightness(1.22); }
  72%{ filter: brightness(1.0); }
  76%{ filter: brightness(1.16); }
  80%{ filter: brightness(.92); }
  84%{ filter: brightness(1.12); }
}
/* ‚úÖ welcome subtitle font -> Oleo Script */
.neonSub{
  margin: 10px auto 0;
  color: rgba(255,255,255,.90);
  max-width: 60ch;
  line-height: 1.5;
  font-family: "Oleo Script", cursive;
  font-weight: 400;
  font-size: 18px;
  text-shadow: 0 10px 22px rgba(0,0,0,.35);
}
.nmIcons{
  position: relative;
  z-index: 2;
  display:flex;
  justify-content:center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.nmChip{
  border-radius: 999px;
  padding: 8px 10px;
  font-weight: 900;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  animation: floatIcon 2.8s ease-in-out infinite;
}
.nmChip:nth-child(2){ animation-delay: .2s; }
.nmChip:nth-child(3){ animation-delay: .4s; }
.nmChip:nth-child(4){ animation-delay: .6s; }
@keyframes floatIcon{
  0%,100%{ transform: translateY(0); }
  50%{ transform: translateY(-4px); }
}

.welcomeCTA{
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
}

/* Coin UI */
.coinArea{
  margin: 10px 0 12px;
  padding: 12px;
  border-radius: 16px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  display: grid;
  gap: 10px;
}
.coinHint{ font-size: 12px; color: rgba(255,255,255,.82); font-weight: 900; text-align: center; }
.coinRow{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  align-items: center;
}
.coinSlot{
  position: relative;
  height: 86px;
  border-radius: 16px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 14px 30px rgba(0,0,0,.25);
  overflow: hidden;
}
.coinMouth{
  position: absolute;
  left: 50%;
  top: 46%;
  transform: translate(-50%,-50%);
  width: 70%;
  height: 16px;
  border-radius: 999px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: inset 0 2px 10px rgba(0,0,0,.70);
}
.coinMouth::after{
  content:"";
  position: absolute;
  inset: 2px 6px;
  border-radius: 999px;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,0));
  opacity: .45;
}
.coinSlot.inserting .coinMouth{ filter: drop-shadow(0 0 14px rgba(255,255,255,.10)); }
.coinSlotLabel{
  position: absolute;
  bottom: 10px;
  width: 100%;
  text-align: center;
  font-size: 11px;
  color: rgba(255,255,255,.78);
  font-weight: 900;
  letter-spacing: .6px;
}
.coinSlotState{
  position: absolute;
  top: 10px;
  width: 100%;
  text-align: center;
  font-size: 11px;
  color: rgba(255,255,255,.86);
  font-weight: 900;
  letter-spacing: .5px;
}
.coinPad{
  position: relative;
  height: 86px;
  border-radius: 16px;
  background: rgba(0,0,0,.18);
  border: 1px dashed rgba(255,255,255,.18);
  display: grid;
  place-items: center;
}

/* Realistic 10 NTD coin */
.coin{
  width: 62px;
  height: 62px;
  border-radius: 999px;
  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.65), rgba(255,255,255,0) 42%),
    radial-gradient(circle at 50% 70%, rgba(0,0,0,.22), rgba(0,0,0,0) 55%),
    radial-gradient(circle at 50% 55%, rgba(220,220,220,.88), rgba(150,150,150,.82));
  border: 2px solid rgba(255,255,255,.30);
  box-shadow:
    inset 0 0 0 2px rgba(0,0,0,.18),
    0 16px 22px rgba(0,0,0,.28),
    0 0 22px rgba(255,220,140,.20);
  display: grid;
  place-items: center;
  user-select: none;
  cursor: grab;
  touch-action: none;
  position: relative;
  letter-spacing: .2px;
}
.coin::before{
  content:"";
  position:absolute;
  inset: -3px;
  border-radius: 999px;
  background: repeating-conic-gradient(
    from 0deg,
    rgba(255,255,255,.22) 0 8deg,
    rgba(0,0,0,.16) 8deg 16deg
  );
  z-index: -1;
  filter: blur(.2px);
  opacity: .55;
}
.coin .coinFace{
  width: 52px;
  height: 52px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(0,0,0,.18);
  box-shadow: inset 0 12px 18px rgba(255,255,255,.12), inset 0 -12px 18px rgba(0,0,0,.18);
  display:grid;
  place-items:center;
  gap: 0px;
}
.coin .coin10{
  font-weight: 1000;
  font-size: 20px;
  color: rgba(60,60,60,.92);
  text-shadow: 0 2px 0 rgba(255,255,255,.35);
  line-height: 1;
}
.coin .coinNtd{
  margin-top: 2px;
  font-weight: 1000;
  font-size: 9px;
  letter-spacing: 1px;
  color: rgba(70,70,70,.85);
  opacity: .95;
}
.coin:active{ cursor: grabbing; transform: scale(.98); }

.coinGhost{
  position: fixed;
  z-index: 9999;
  pointer-events: none;
  transform: translate(-50%,-50%);
  opacity: .98;
  filter: drop-shadow(0 16px 18px rgba(0,0,0,.25));
}
.coinDrop{
  transition:
    left 220ms ease,
    top 220ms ease,
    transform 220ms ease,
    opacity 220ms ease,
    filter 220ms ease;
}

/* Big message overlay */
.bigMsg{
  position: fixed;
  inset: 0;
  z-index: 40;
  display: grid;
  place-items: center;
  background: rgba(0,0,0,.50);
  backdrop-filter: blur(5px);
  padding: 18px;
}
.bigMsg.hidden{ display: none; }
.bigMsgInner{
  text-align: center;
  padding: 18px;
  border-radius: 20px;
  background:
    radial-gradient(900px circle at 50% 0%, rgba(255,255,255,.14), transparent 60%),
    rgba(0,0,0,.26);
  border: 1px solid rgba(255,255,255,.16);
  box-shadow: var(--shadow);
  width: min(760px, 92vw);
  overflow: hidden;
  position: relative;
}
.bigTitle{
  font-family: "Protest Revolution", "Inter", system-ui;
  font-size: clamp(34px, 5.0vw, 62px);
  font-weight: 400;
  letter-spacing: .8px;
}
.bigSub{
  margin-top: 8px;
  color: rgba(255,255,255,.85);
  font-size: clamp(13px, 2vw, 18px);
  font-weight: 900;
  white-space: pre-line;
}
.bigTicker{
  margin: 12px auto 0;
  width: min(640px, 100%);
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  overflow: hidden;
  box-shadow: 0 14px 30px rgba(0,0,0,.22);
  display: none;
}
.bigTicker.show{ display: block; }
.bigTickerTrack{
  white-space: nowrap;
  display: inline-block;
  padding: 10px 0;
  animation: tickerRun 6.4s linear infinite;
}
.bigTickerText{
  display: inline-block;
  font-weight: 1000;
  letter-spacing: .8px;
  color: rgba(255,255,255,.92);
  text-shadow: 0 10px 18px rgba(0,0,0,.35);
  padding: 0 22px;
}
@keyframes tickerRun{
  0%{ transform: translateX(0); }
  100%{ transform: translateX(-50%); }
}

/* ‚úÖ End Congrats modal (shows ONLY when ending) */
.endCard{
  width: min(820px, 92vw);
  border-radius: 26px;
  padding: 16px;
  background:
    radial-gradient(1000px circle at 50% 0%, rgba(255,255,255,.18), transparent 55%),
    radial-gradient(900px circle at 20% 40%, rgba(255,120,40,.16), transparent 55%),
    radial-gradient(900px circle at 80% 40%, rgba(255,0,200,.14), transparent 55%),
    rgba(0,0,0,.34);
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 22px 80px rgba(0,0,0,.55);
  text-align: center;
  position: relative;
  overflow: hidden;
}
.endCard::before{
  content:"";
  position:absolute; inset:-90px;
  background:
    radial-gradient(circle at 25% 30%, rgba(120,255,240,.18), transparent 55%),
    radial-gradient(circle at 75% 30%, rgba(255,110,220,.18), transparent 58%),
    radial-gradient(circle at 50% 10%, rgba(255,230,140,.16), transparent 55%);
  animation: nmGlow 6.2s ease-in-out infinite;
  pointer-events:none;
  opacity: .9;
}
.endTop{
  position: relative;
  z-index: 2;
  display: grid;
  gap: 12px;
  justify-items: center;
}
.endTitle{
  margin: 0;
  font-family: "Protest Revolution", "Inter", system-ui;
  font-size: clamp(30px, 4.2vw, 56px);
  font-weight: 400;
  letter-spacing: .8px;
}
.endTitle .pink{ color: rgba(255,120,220,.95); text-shadow: 0 0 16px rgba(255,120,220,.28); }
.endTitle .gold{ color: rgba(255,220,150,.95); text-shadow: 0 0 16px rgba(255,220,150,.22); }
.endSub{
  margin: 0;
  color: rgba(255,255,255,.88);
  font-weight: 900;
  white-space: pre-line;
  line-height: 1.4;
}
.endGrid{
  width: min(720px, 100%);
  display: grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap: 10px;
  margin-top: 6px;
}
@media (max-width: 700px){
  .endGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
}
.endToy{
  border-radius: 18px;
  padding: 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 12px 30px rgba(0,0,0,.22);
  display: grid;
  gap: 6px;
  justify-items: center;
}
.endToy .e{ font-size: 44px; filter: drop-shadow(0 14px 18px rgba(0,0,0,.35)); }
.endToy .n{
  font-weight: 1000;
  font-size: 12px;
  line-height: 1.15;
  color: rgba(255,255,255,.92);
}
.endChips{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content:center;
}
.endBtns{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content:center;
  margin-top: 10px;
}

/* Prize shop */
.shopStats{ display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0 12px; justify-content: center; }
.shopGrid{
  display: grid;
  gap: 14px;
  grid-template-columns: repeat(4, minmax(0,1fr));
}
.shopItem{
  border-radius: 18px;
  padding: 14px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 12px 30px rgba(0,0,0,.22);
  transform: translateY(6px);
  opacity: 0;
  animation: shopIn .32s ease-out forwards;
}
.shopItem:nth-child(2){ animation-delay: .05s; }
.shopItem:nth-child(3){ animation-delay: .10s; }
.shopItem:nth-child(4){ animation-delay: .15s; }
.shopItem:nth-child(5){ animation-delay: .20s; }
.shopItem:nth-child(6){ animation-delay: .25s; }
.shopItem:nth-child(7){ animation-delay: .30s; }
.shopItem:nth-child(8){ animation-delay: .35s; }
@keyframes shopIn{ to{ transform: translateY(0); opacity: 1; } }
.shopName{
  font-weight: 1000;
  margin: 0 0 8px 0;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.shopEmoji{ font-size: 42px; line-height: 1; }
.shopDesc{ margin: 0 0 10px 0; color: rgba(255,255,255,.80); font-size: 13px; line-height: 1.35; }
.shopBuyRow{ display: flex; justify-content: space-between; align-items: center; gap: 10px; }
.shopCost{ font-weight: 1000; font-size: 13px; }
.shopFooter{ margin-top: 12px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

/* Footer */
.footer{
  opacity: .9;
  font-size: 12px;
  text-align: center;
  font-weight: 700;
  padding-bottom: 6px;
}
  </style>
</head>

<body>
  <!-- ‚úÖ Stars background -->
  <div id="stars" aria-hidden="true"></div>

  <div id="balloons" aria-hidden="true"></div>

  <!-- FX -->
  <canvas id="confetti" aria-hidden="true"></canvas>
  <div id="fxLayer" aria-hidden="true"></div>

  <!-- WELCOME MODAL (2 pages) -->
  <div id="welcomeModal" class="modal show" role="dialog" aria-modal="true">
    <div class="modalCard">

      <!-- PAGE 1: Night Market Welcome -->
      <div id="welcomePage">
        <div class="welcomeWrap">
          <div class="nmHero">
            <div class="twinkleLayer" id="twinkles" aria-hidden="true"></div>
            <div class="sparkles" id="sparkles" aria-hidden="true"></div>

            <div class="flagRow" aria-hidden="true">
              <div class="flagString"></div>
              <div class="flags" id="flags"></div>
            </div>

            <div class="neonSign">
              <div class="neonKicker">NIGHT MARKET GAME</div>

              <!-- ‚úÖ title words different colors -->
              <h2 class="neonTitle">
                <span class="w1">Color</span> <span class="w2">Memory</span> <span class="w3">Wheel</span>
              </h2>

              <!-- ‚úÖ subtitle now Oleo Script -->
              <p class="neonSub">Spin the wheel, watch the flashing colors, repeat the sequence, and collect tickets for prizes üéüÔ∏è</p>

              <div class="nmIcons" aria-hidden="true">
                <!-- ‚úÖ removed ‚ÄúNight Market Lights‚Äù chip -->
                <div class="nmChip">üß∏ Prizes</div>
                <div class="nmChip">üéà Bonus</div>
                <div class="nmChip">üé° Spin</div>
              </div>
            </div>
          </div>

          <div class="welcomeCTA">
            <button id="welcomeNextBtn" class="btn primary glowBtn" type="button">Enter the Night Market ‚ú®</button>
          </div>
        </div>
      </div>

      <!-- PAGE 2: Instructions + Coin -->
      <div id="instructionsPage" class="hiddenPage">
        <h2 class="modalTitle oneLine">How to Play</h2>
        <p class="modalSub oneLine">Color Memory Wheel</p>

        <div class="modalSection" style="background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 16px; padding: 12px; margin-bottom: 14px;">
          <h3 class="modalH" style="text-align:center; margin:0 0 8px 0; font-size:13px; color:rgba(255,255,255,.9); font-weight:900;">Instructions</h3>
          <ol class="modalList" style="margin:0; padding-left:18px; color:rgba(255,255,255,.82); line-height:1.45; font-weight:600;">
            <li>Drag the <b>10 NTD coin</b> into the coin slot.</li>
            <li>Press <b>Start Game</b>.</li>
            <li>Watch the wheel flash the pattern (each color has its own sound).</li>
            <li>Tap the colors in the same order.</li>
            <li>Earn <b>+1 ticket</b> after every successful round.</li>
            <li><b>Bonus each round:</b> a <b>ticket</b> gives <b>+1 ticket</b>, or a <b>balloon</b> gives <b>+seconds</b>.</li>
          </ol>
        </div>

        <div class="coinArea">
          <div class="coinHint">Insert Coin (drag into the slot)</div>
          <div class="coinRow">
            <div id="coinSlot" class="coinSlot" aria-hidden="true">
              <div class="coinMouth" aria-hidden="true"></div>
              <div id="coinSlotState" class="coinSlotState">NO COIN</div>
              <div class="coinSlotLabel">COIN SLOT</div>
            </div>
            <div class="coinPad">
              <div id="coin" class="coin" role="button" aria-label="10 NTD coin">
                <div class="coinFace">
                  <div class="coin10">10</div>
                  <div class="coinNtd">NTD</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button id="startBtn" class="btn primary bigBtn glowBtn" type="button" disabled>Start Game</button>

        <div class="modalNav">
          <button id="welcomeBackBtn" class="btn" type="button">Back</button>
        </div>
      </div>

    </div>
  </div>

  <!-- BIG MESSAGE OVERLAY -->
  <div id="bigMsg" class="bigMsg hidden" aria-hidden="true">
    <div class="bigMsgInner">
      <div id="bigTitle" class="bigTitle">...</div>
      <div id="bigSub" class="bigSub">...</div>

      <div id="bigTicker" class="bigTicker" aria-hidden="true">
        <div id="bigTickerTrack" class="bigTickerTrack">
          <span id="bigTickerTextA" class="bigTickerText">...</span>
          <span id="bigTickerTextB" class="bigTickerText">...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ END CONGRATS (ONLY when user ends) -->
  <div id="endCongratsModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="endCard">
      <div class="endTop">
        <h2 class="endTitle"><span class="pink">CONGRATS</span> <span class="gold">WINNER!</span></h2>
        <p id="endSub" class="endSub">You collected prizes!</p>

        <div class="endChips">
          <div class="shopChip"><span class="k">Tickets left:</span> <span id="endTickets">0</span></div>
          <div class="shopChip"><span class="k">Prizes:</span> <span id="endPrizeCount">0</span></div>
          <div class="shopChip"><span class="k">Best:</span> <span id="endBest">0</span></div>
        </div>

        <div id="endToysGrid" class="endGrid"></div>

        <div class="endBtns">
          <button id="endBackToWelcomeBtn" class="btn primary glowBtn" type="button">Back to Welcome</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PRIZE SHOP MODAL -->
  <div id="shopModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalCard wide">
      <h2 class="modalTitle">Prize Shop</h2>
      <p class="modalSub oneLine">Spend tickets on toys ‚Äî or continue playing.</p>

      <div class="shopStats">
        <div class="shopChip"><span class="k">Tickets:</span> <span id="shopTickets">0</span></div>
        <div class="shopChip"><span class="k">Toy Prizes:</span> <span id="prizeCount">0</span></div>
        <div class="shopChip"><span class="k">Best:</span> <span id="shopBest">0</span></div>
      </div>

      <div id="shopItems" class="shopGrid"></div>

      <div class="shopFooter">
        <button id="shopContinueBtn" class="btn primary" type="button">Continue Game</button>
        <button id="backToHomeBtn" class="btn" type="button">End</button>
      </div>
    </div>
  </div>

  <!-- SCALE ROOT -->
  <div id="scaleRoot">
    <main class="app">
      <section class="stage">
        <aside class="leftPanel">
          <div class="panelTitle">Game Details</div>

          <div class="hudGrid">
            <div class="stat">
              <div class="statLabel">Round</div>
              <div class="statValue" id="roundEl">0</div>
            </div>
            <div class="stat">
              <div class="statLabel">Tickets</div>
              <div class="statValue" id="ticketsEl">0</div>
            </div>
            <div class="stat">
              <div class="statLabel">Prizes</div>
              <div class="statValue" id="prizesEl">0</div>
            </div>
            <div class="stat">
              <div class="statLabel">Best</div>
              <div class="statValue" id="bestEl">0</div>
            </div>
          </div>

          <div class="panel">
            <div class="status" id="statusEl">Insert coin on the welcome page to start.</div>

            <div class="bonusWrap">
              <div class="bonusLabel">Bonus (each round)</div>
              <div id="bonusBalloons" class="bonusBalloons"></div>
            </div>

            <div class="rows">
              <div class="row">
                <div class="rowLabel">Pattern length</div>
                <div class="pips" id="patternSlots"></div>
              </div>

              <div class="row">
                <div class="rowLabel">Your input</div>
                <div class="pips" id="playerPips"></div>
              </div>
            </div>

            <div class="hint">Tip: Memorize the sequence as numbers (1‚Äì10), then tap in the same order.</div>
          </div>
        </aside>

        <section class="centerCol">
          <div class="centerHeader">
            <!-- ‚úÖ title words different colors -->
            <div class="centerTitle titleWords">
              <span class="w1">Color</span> <span class="w2">Memory</span> <span class="w3">Wheel</span>
            </div>
            <div class="centerSubtitle oneLine">Spin ‚Ä¢ Watch ‚Ä¢ Remember</div>
          </div>

          <div class="wheelWrap">
            <div class="pointer" aria-hidden="true"></div>
            <div id="wheelLights" class="wheelLights" aria-hidden="true"></div>

            <div id="rotator" class="rotator">
              <svg id="wheelSvg" viewBox="0 0 300 300" role="img" aria-label="Color memory wheel"></svg>
            </div>

            <div class="centerOverlay" aria-hidden="true">
              <div class="centerGlass">
                <svg class="hg" viewBox="0 0 100 100">
                  <defs>
                    <clipPath id="topClip"><rect id="topRect" x="25" y="10" width="50" height="40"></rect></clipPath>
                    <clipPath id="bottomClip"><rect id="bottomRect" x="25" y="90" width="50" height="0"></rect></clipPath>
                  </defs>
                  <polygon class="hgSand" points="25,10 75,10 60,50 40,50" clip-path="url(#topClip)"></polygon>
                  <polygon class="hgSand" points="40,50 60,50 75,90 25,90" clip-path="url(#bottomClip)"></polygon>
                  <polygon class="hgGlass" points="25,10 75,10 60,50 75,90 25,90 40,50"></polygon>
                  <line class="hgNeck" x1="50" y1="48" x2="50" y2="52"></line>
                </svg>
                <div class="timerText" id="timerText">--</div>
              </div>
            </div>
          </div>
        </section>

        <aside class="rightPanel">
          <div class="panelTitle">Prize Toys</div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
            <div class="shopChip"><span class="k">Owned:</span> <span id="ownedCount">0</span></div>
            <div class="shopChip"><span class="k">Tickets:</span> <span id="ticketsChip">0</span></div>
          </div>

          <div id="allToysGrid" class="allToysGrid"></div>

          <div class="hint" style="padding:10px 12px;border-radius:14px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.14);">
            Lose a run to open the Prize Shop.
          </div>
        </aside>
      </section>

      <footer class="footer">
        <span>Created by Mirene Jane Grejalde (Ë≤¥ÊïèÂ∏å)</span>
      </footer>
    </main>
  </div>

  <script>
const SLICE_COLORS = [
  "#FF3B3B","#FF8C00","#FFD400","#A7F432","#00C853",
  "#00E5FF","#00A3FF","#3F51B5","#8A2BE2","#FF4FD8"
];

let SHOP_ITEMS = [
  { id:"ball",   emoji:"‚öΩ", name:"Mini Bouncy Ball",       cost:2,  desc:"Small, bouncy, and impossible to not toss." },
  { id:"bt",     emoji:"üßã", name:"Bubble Tea Keyring",     cost:4,  desc:"A boba keyring that screams night market." },
  { id:"duck",   emoji:"ü¶Ü", name:"Rubber Duck",            cost:4,  desc:"Classic squeaky duck for pure joy." },
  { id:"yoyo",   emoji:"ü™Ä", name:"Classic Yo-Yo",          cost:6,  desc:"Smooth spin yo-yo for simple tricks." },
  { id:"car",    emoji:"üöó", name:"Wind-Up Toy Car",        cost:6,  desc:"Wind it up and it zooms across the table." },
  { id:"cube",   emoji:"üß©", name:"Mini Puzzle Cube",       cost:8,  desc:"A tiny cube puzzle to keep your hands busy." },
  { id:"squish", emoji:"üêô", name:"Squishy Octopus",        cost:8,  desc:"Soft squishy toy‚Äîsuper popular at night markets." },
  { id:"teddy",  emoji:"üß∏", name:"Plush Teddy Bear",       cost:10, desc:"Big soft plush prize ‚Äî top shelf reward!" },
];
function sortShopItems(){ SHOP_ITEMS = [...SHOP_ITEMS].sort((a,b) => a.cost - b.cost || a.name.localeCompare(b.name)); }
sortShopItems();

const els = {
  stars: document.getElementById("stars"),
  balloons: document.getElementById("balloons"),
  confetti: document.getElementById("confetti"),
  fxLayer: document.getElementById("fxLayer"),
  scaleRoot: document.getElementById("scaleRoot"),

  twinkles: document.getElementById("twinkles"),
  sparkles: document.getElementById("sparkles"),
  flags: document.getElementById("flags"),

  welcomeModal: document.getElementById("welcomeModal"),
  welcomePage: document.getElementById("welcomePage"),
  instructionsPage: document.getElementById("instructionsPage"),
  welcomeNextBtn: document.getElementById("welcomeNextBtn"),
  welcomeBackBtn: document.getElementById("welcomeBackBtn"),

  startBtn: document.getElementById("startBtn"),
  coin: document.getElementById("coin"),
  coinSlot: document.getElementById("coinSlot"),
  coinSlotState: document.getElementById("coinSlotState"),

  bigMsg: document.getElementById("bigMsg"),
  bigTitle: document.getElementById("bigTitle"),
  bigSub: document.getElementById("bigSub"),
  bigTicker: document.getElementById("bigTicker"),
  bigTickerTextA: document.getElementById("bigTickerTextA"),
  bigTickerTextB: document.getElementById("bigTickerTextB"),
  bigTickerTrack: document.getElementById("bigTickerTrack"),

  endCongratsModal: document.getElementById("endCongratsModal"),
  endSub: document.getElementById("endSub"),
  endTickets: document.getElementById("endTickets"),
  endPrizeCount: document.getElementById("endPrizeCount"),
  endBest: document.getElementById("endBest"),
  endToysGrid: document.getElementById("endToysGrid"),
  endBackToWelcomeBtn: document.getElementById("endBackToWelcomeBtn"),

  shopModal: document.getElementById("shopModal"),
  shopItems: document.getElementById("shopItems"),
  shopTickets: document.getElementById("shopTickets"),
  prizeCount: document.getElementById("prizeCount"),
  shopBest: document.getElementById("shopBest"),
  backToHomeBtn: document.getElementById("backToHomeBtn"),
  shopContinueBtn: document.getElementById("shopContinueBtn"),

  roundEl: document.getElementById("roundEl"),
  bestEl: document.getElementById("bestEl"),
  ticketsEl: document.getElementById("ticketsEl"),
  ticketsChip: document.getElementById("ticketsChip"),
  prizesEl: document.getElementById("prizesEl"),

  ownedCount: document.getElementById("ownedCount"),
  allToysGrid: document.getElementById("allToysGrid"),

  statusEl: document.getElementById("statusEl"),
  patternSlots: document.getElementById("patternSlots"),
  playerPips: document.getElementById("playerPips"),
  bonusBalloons: document.getElementById("bonusBalloons"),

  wheelSvg: document.getElementById("wheelSvg"),
  rotator: document.getElementById("rotator"),
  wheelLights: document.getElementById("wheelLights"),

  timerText: document.getElementById("timerText"),
  topRect: document.getElementById("topRect"),
  bottomRect: document.getElementById("bottomRect"),
};

let best = Number(localStorage.getItem("mcw_best_carnival") || "0");
let prizesOwned = JSON.parse(localStorage.getItem("mcw_prizes_owned_carnival") || "[]");

let segments = [];
let rotationDeg = 0;
let gameActive = false;
let busy = false;
let isPlayerTurn = false;

let round = 0;
let tickets = 0;

let sequence = [];
let expected = [];
let player = [];

let rafId = null;
let timerStart = 0;
let timerTotal = 0;
let pendingTimeBonusMs = 0;

let audioCtx = null;
let master = null;

let coinInserted = false;
let balloonInterval = null;

function wait(ms){ return new Promise(r => setTimeout(r, ms)); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function shuffle(arr){
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function setStatus(msg){ els.statusEl.textContent = msg; }

/* ‚úÖ Stars */
function buildStars(){
  if (!els.stars) return;
  els.stars.innerHTML = "";
  const n = 70; // medium amount
  for (let i=0;i<n;i++){
    const s = document.createElement("div");
    s.className = "star";
    const size = (3 + Math.random()*5).toFixed(2); // medium size
    s.style.setProperty("--x", `${(Math.random()*100).toFixed(2)}%`);
    s.style.setProperty("--y", `${(Math.random()*100).toFixed(2)}%`);
    s.style.setProperty("--s", `${size}px`);
    s.style.setProperty("--t", `${(2.4 + Math.random()*3.4).toFixed(2)}s`);
    s.style.setProperty("--d", `${(-Math.random()*3.5).toFixed(2)}s`);
    els.stars.appendChild(s);
  }
}

/* Welcome decor */
function buildFlags(){
  els.flags.innerHTML = "";
  const n = 34;
  for (let i=0;i<n;i++){
    const f = document.createElement("div");
    f.className = "flag";
    f.style.setProperty("--h", String(Math.floor(Math.random()*360)));
    f.style.setProperty("--d", `${(-Math.random()*1.7).toFixed(2)}s`);
    els.flags.appendChild(f);
  }
}
function buildSparkles(){
  els.sparkles.innerHTML = "";
  const n = 18;
  for (let i=0;i<n;i++){
    const s = document.createElement("div");
    s.className = "sparkle";
    s.style.setProperty("--x", `${(8 + Math.random()*84).toFixed(2)}%`);
    s.style.setProperty("--y", `${(10 + Math.random()*72).toFixed(2)}%`);
    s.style.setProperty("--t", `${(1.8 + Math.random()*2.2).toFixed(2)}s`);
    s.style.setProperty("--d", `${(-Math.random()*2.5).toFixed(2)}s`);
    els.sparkles.appendChild(s);
  }
}
function buildTwinkles(){
  els.twinkles.innerHTML = "";
  const n = 28;
  for (let i=0;i<n;i++){
    const d = document.createElement("div");
    d.className = "twDot";
    d.style.setProperty("--x", `${(6 + Math.random()*88).toFixed(2)}%`);
    d.style.setProperty("--y", `${(8 + Math.random()*72).toFixed(2)}%`);
    d.style.setProperty("--t", `${(1.6 + Math.random()*1.8).toFixed(2)}s`);
    d.style.setProperty("--d", `${(-Math.random()*2.6).toFixed(2)}s`);
    els.twinkles.appendChild(d);
  }
}

/* ‚úÖ Auto-scale */
function applyAppScale(){
  document.documentElement.style.setProperty("--appScale", "1");
  const rect = els.scaleRoot.getBoundingClientRect();
  const pad = 18;
  const vw = window.innerWidth - pad * 2;
  const vh = window.innerHeight - pad * 2;
  const sx = vw / rect.width;
  const sy = vh / rect.height;
  const s = Math.min(1, sx, sy);
  document.documentElement.style.setProperty("--appScale", String(s));
  resizeConfettiCanvas();
}
window.addEventListener("resize", () => {
  applyAppScale();
  renderAllToys();
  renderShopItems();
  buildStars();
});

/* Welcome pages */
function showWelcome(){
  els.welcomeModal.classList.add("show");
  els.welcomeModal.classList.remove("hidden");
  showWelcomePage();
  setStatus("Welcome! Enter to see instructions and insert coin.");
  confettiBurst(window.innerWidth * 0.5, window.innerHeight * 0.35, 90, 4.2);
}
function hideWelcome(){
  els.welcomeModal.classList.remove("show");
  els.welcomeModal.classList.add("hidden");
}
function showWelcomePage(){
  els.welcomePage.classList.remove("hiddenPage");
  els.instructionsPage.classList.add("hiddenPage");
}
function showInstructionsPage(){
  els.welcomePage.classList.add("hiddenPage");
  els.instructionsPage.classList.remove("hiddenPage");
}

/* Big message overlay with optional ticker */
async function showBigMessage({title, sub = "", ms = 900, tickerText = ""}){
  els.bigTitle.textContent = title;
  els.bigSub.textContent = sub;

  if (tickerText){
    els.bigTickerTextA.textContent = tickerText;
    els.bigTickerTextB.textContent = tickerText;
    els.bigTicker.classList.add("show");
    els.bigTickerTrack.style.animation = "none";
    void els.bigTickerTrack.offsetHeight;
    els.bigTickerTrack.style.animation = "";
  } else {
    els.bigTicker.classList.remove("show");
  }

  els.bigMsg.classList.remove("hidden");
  await wait(ms);
  els.bigMsg.classList.add("hidden");
  els.bigTicker.classList.remove("show");
}

/* Balloons */
function spawnOneBalloon({xPct=null, durationS=null, sizePx=null} = {}){
  const b = document.createElement("div");
  b.className = "balloon";
  const x = xPct ?? (Math.random() * 100);
  const w = sizePx ?? (44 + Math.random() * 60);
  const t = durationS ?? (10 + Math.random() * 10);
  b.style.setProperty("--x", `${x}%`);
  b.style.setProperty("--w", `${w}px`);
  b.style.setProperty("--h", `${Math.floor(Math.random() * 360)}`);
  b.style.setProperty("--t", `${t}s`);
  b.style.setProperty("--s", `${60 + Math.random() * 120}px`);
  const string = document.createElement("div");
  string.className = "string";
  b.appendChild(string);
  els.balloons.appendChild(b);
  setTimeout(() => { if (b.isConnected) b.remove(); }, (t * 1000) + 1200);
}
function spawnBackgroundBalloons(){
  for (let i = 0; i < 28; i++) spawnOneBalloon({ durationS: 9 + Math.random() * 10 });
  if (balloonInterval) clearInterval(balloonInterval);
  balloonInterval = setInterval(() => {
    spawnOneBalloon();
    if (Math.random() < 0.35) spawnOneBalloon();
  }, 900);
}

/* Wheel lights */
function buildWheelLights(){
  els.wheelLights.innerHTML = "";
  const n = 36;
  for (let i = 0; i < n; i++){
    const a = (Math.PI * 2) * (i / n);
    const x = 50 + Math.cos(a) * 48;
    const y = 50 + Math.sin(a) * 48;
    const b = document.createElement("div");
    b.className = "wheelBulb";
    b.style.left = `${x}%`;
    b.style.top = `${y}%`;
    b.style.setProperty("--d", `${(-Math.random()*2.4).toFixed(2)}s`);
    els.wheelLights.appendChild(b);
  }
}

/* Wheel */
function buildSegments(){
  const palette = shuffle(SLICE_COLORS);
  segments = palette.map(c => ({ color: c }));
}
function polarToXY(cx, cy, r, angleDeg){
  const rad = (angleDeg * Math.PI) / 180;
  return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
}
function wedgePath(cx, cy, r, startDeg, endDeg){
  const a0 = polarToXY(cx, cy, r, startDeg);
  const a1 = polarToXY(cx, cy, r, endDeg);
  const largeArc = (endDeg - startDeg) > 180 ? 1 : 0;
  return `M ${cx} ${cy} L ${a0.x} ${a0.y} A ${r} ${r} 0 ${largeArc} 1 ${a1.x} ${a1.y} Z`;
}
function renderWheel(){
  els.wheelSvg.innerHTML = "";
  const cx = 150, cy = 150, r = 140;
  const n = segments.length;
  const slice = 360 / n;

  const ring = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  ring.setAttribute("cx", cx);
  ring.setAttribute("cy", cy);
  ring.setAttribute("r", r - 1);
  ring.setAttribute("fill", "none");
  ring.setAttribute("stroke", "rgba(255,255,255,.18)");
  ring.setAttribute("stroke-width", "6");
  els.wheelSvg.appendChild(ring);

  for (let i = 0; i < n; i++){
    const seg = segments[i];
    const start = i * slice - 90;
    const end = (i + 1) * slice - 90;

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", wedgePath(cx, cy, r, start, end));
    path.setAttribute("fill", seg.color);
    path.classList.add("slice");
    path.dataset.slice = String(i);
    path.style.setProperty("--glow", seg.color);
    els.wheelSvg.appendChild(path);
  }
}
function setSlicesDim(dim){
  els.wheelSvg.querySelectorAll(".slice").forEach(n => n.classList.toggle("sliceDim", dim));
}

/* Sounds: each color different */
const COLOR_TONES = [262, 294, 330, 349, 392, 440, 494, 523, 587, 659];
const COLOR_WAVES = ["sine","triangle","sine","triangle","sine","triangle","sine","triangle","sine","triangle"];
function sfxColor(index, kind="tap"){
  if (!audioCtx || !master) return;
  const i = clamp(index|0, 0, 9);
  const t = audioCtx.currentTime;
  const base = COLOR_TONES[i];
  const type = COLOR_WAVES[i];
  const g = (kind === "flash") ? 0.06 : 0.10;
  const dur = (kind === "flash") ? 0.07 : 0.10;
  tone(base, t, dur, type, g);
  tone(base * 2, t + 0.015, dur * 0.7, "sine", g * 0.55);
}

async function flashSlice(sliceIndex, ms){
  const node = els.wheelSvg.querySelector(`.slice[data-slice="${sliceIndex}"]`);
  if (!node) return wait(ms);
  node.style.setProperty("--glow", segments[sliceIndex].color);
  node.classList.add("flash");
  sfxColor(sliceIndex, "flash");
  await wait(ms);
  node.classList.remove("flash");
}

/* Spin */
function spinOnce(durationMs){
  return new Promise((resolve) => {
    rotationDeg += 1800 + Math.random() * 2400;
    els.rotator.style.transition = `transform ${durationMs}ms cubic-bezier(.18,.88,.1,1)`;
    els.rotator.style.transform = `rotate(${rotationDeg}deg)`;
    const onEnd = (ev) => {
      if (ev.propertyName !== "transform") return;
      els.rotator.removeEventListener("transitionend", onEnd);
      resolve();
    };
    els.rotator.addEventListener("transitionend", onEnd);
  });
}

/* Hourglass */
function setHourglass(fraction){
  const clamped = Math.max(0, Math.min(1, fraction));
  const topH = 40 * clamped;
  const bottomH = 40 * (1 - clamped);
  els.topRect.setAttribute("height", topH.toFixed(2));
  const bottomY = 90 - bottomH;
  els.bottomRect.setAttribute("y", bottomY.toFixed(2));
  els.bottomRect.setAttribute("height", bottomH.toFixed(2));
}
function stopTimer(){
  if (rafId){ cancelAnimationFrame(rafId); rafId = null; }
  els.timerText.textContent = "--";
  setHourglass(1);
}
function addTimeBonus(ms){
  if (rafId){
    timerTotal = Math.min(45000, timerTotal + ms);
  } else {
    pendingTimeBonusMs = Math.min(45000, pendingTimeBonusMs + ms);
  }
}
function startTimer(){
  stopTimer();
  const base = 2400;
  const perPick = 980;
  timerTotal = Math.min(32000, base + (expected.length * perPick) + pendingTimeBonusMs);
  pendingTimeBonusMs = 0;

  timerStart = performance.now();
  const tick = (now) => {
    const elapsed = now - timerStart;
    const remaining = Math.max(0, timerTotal - elapsed);
    const frac = remaining / timerTotal;
    setHourglass(frac);
    els.timerText.textContent = `${(remaining / 1000).toFixed(1)}s`;
    if (remaining <= 0){ loseGame("TIME UP"); return; }
    rafId = requestAnimationFrame(tick);
  };
  rafId = requestAnimationFrame(tick);
}

/* Pips */
function renderSlots(len){
  els.patternSlots.innerHTML = "";
  for (let i = 0; i < len; i++){
    const d = document.createElement("div");
    d.className = "pip slot";
    els.patternSlots.appendChild(d);
  }
}
function renderPlayerPips(){
  els.playerPips.innerHTML = "";
  for (const s of player){
    const d = document.createElement("div");
    d.className = "pip";
    d.style.background = segments[s].color;
    els.playerPips.appendChild(d);
  }
}

/* Bonus */
function clearBonusBalloons(){ els.bonusBalloons.innerHTML = ""; }

function spawnTicketBonus(){
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "bonusBtn bonusTicket";
  btn.innerHTML = `<div class="ticketInner"><span class="ticketIcon">üéüÔ∏è</span><span>+1 TICKET</span></div>`;
  btn.addEventListener("click", () => {
    ensureAudio();
    if (!gameActive) return;
    tickets += 1;
    updateHUD();
    setStatus("Bonus ticket! +1 ticket üéüÔ∏è");
    sfxBell();
    const r = btn.getBoundingClientRect();
    confettiBurst(r.left + r.width/2, r.top + r.height/2, 70, 3.6);
    btn.classList.add("pop");
    setTimeout(() => btn.remove(), 180);
  });
  return btn;
}

function spawnSecondsBalloon(){
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "bonusBtn bonusBalloonCircle";
  btn.style.setProperty("--h", `${Math.floor(Math.random() * 360)}`);
  const bonusMs = 2500; // +2.5 seconds
  btn.innerHTML = `
    <div>
      <div class="big">+2.5s</div>
      <div class="small">TIME</div>
    </div>
    <div class="string" aria-hidden="true"></div>
  `;
  btn.addEventListener("click", () => {
    ensureAudio();
    if (!gameActive) return;
    addTimeBonus(bonusMs);
    setStatus("Bonus time! +2.5 seconds ‚è±Ô∏è");
    sfxBell();
    const r = btn.getBoundingClientRect();
    confettiBurst(r.left + r.width/2, r.top + r.height/2, 70, 3.6);
    btn.classList.add("pop");
    setTimeout(() => btn.remove(), 180);
  });
  return btn;
}

function spawnRoundBonus(){
  clearBonusBalloons();
  if (!gameActive) return;

  const node = (Math.random() < 0.5) ? spawnTicketBonus() : spawnSecondsBalloon();
  els.bonusBalloons.appendChild(node);

  setTimeout(() => {
    if (!node.isConnected) return;
    node.classList.add("pop");
    setTimeout(() => node.remove(), 220);
  }, 5000);
}

/* Pattern */
function randomColorIndex(){
  let idx = Math.floor(Math.random() * 10);
  if (sequence.length){
    const last = sequence[sequence.length - 1];
    if (idx === last && Math.random() < 0.75){
      idx = (idx + 1 + Math.floor(Math.random() * 9)) % 10;
    }
  }
  return idx;
}

/* Flash speed up at round 5+ */
function getFlashTiming(){
  let flashMs = clamp(520 - round * 28, 160, 520);
  let gapMs   = clamp(120 - round * 5,  42, 120);

  if (round >= 5){
    flashMs = Math.max(120, Math.floor(flashMs * 0.72));
    gapMs   = Math.max(30,  Math.floor(gapMs   * 0.72));
  }
  if (round >= 8){
    flashMs = Math.max(95, Math.floor(flashMs * 0.82));
    gapMs   = Math.max(24, Math.floor(gapMs   * 0.82));
  }
  return { flashMs, gapMs };
}

async function showSequence(){
  setSlicesDim(true);
  sfxBell();
  const { flashMs, gapMs } = getFlashTiming();
  for (const s of sequence){
    await wait(gapMs);
    await flashSlice(s, flashMs);
  }
  setSlicesDim(false);
}

async function playRound(){
  busy = true;
  isPlayerTurn = false;
  player = [];
  renderPlayerPips();
  renderSlots(sequence.length);
  expected = [...sequence];

  setStatus(`Round ${round}: spinning...`);
  await spinOnce(Math.min(6500, 3300 + round * 180));

  setStatus("Watch the pattern.");
  await showSequence();

  setStatus("Spinning again...");
  await spinOnce(2200);

  setStatus("Your turn: repeat the colors.");
  isPlayerTurn = true;
  busy = false;

  startTimer();
}

async function advanceRound(){
  round += 1;
  sequence.push(randomColorIndex());
  updateHUD();
  spawnRoundBonus();

  if (round >= 2){
    const ticker = `üèÆüéè‚ú® üç¢üßãüç° üéüÔ∏èüé°üß∏  ‚ûú  PROCEEDING TO ROUND ${round}  ‚ûú  GET READY!  üèÆüéè‚ú® üç¢üßãüç° üéüÔ∏èüé°üß∏`;
    await showBigMessage({
      title: `ROUND ${round}`,
      sub: "Proceeding...",
      ms: 1800,
      tickerText: ticker
    });
  }

  await playRound();
}

/* Lose + Shop */
async function loseGame(reason){
  stopTimer();
  isPlayerTurn = false;
  busy = false;
  clearBonusBalloons();
  pendingTimeBonusMs = 0;

  const score = Math.max(0, round - 1);
  const newBest = score > best;
  best = Math.max(best, score);
  localStorage.setItem("mcw_best_carnival", String(best));

  gameActive = false;
  updateHUD();

  sfxBuzzer();
  await showBigMessage({ title: "GAME OVER!", sub: `Reason: ${reason}`, ms: 1000, tickerText: "" });

  if (newBest){
    confettiBurst(window.innerWidth * 0.5, window.innerHeight * 0.35, 220, 5.2);
  }
  openShop();
}

/* Player input */
function onPlayerPick(colorIndex){
  if (!gameActive || !isPlayerTurn || busy) return;

  ensureAudio();
  sfxColor(colorIndex, "tap");
  flashSlice(colorIndex, 210);

  player.push(colorIndex);
  renderPlayerPips();

  const idx = player.length - 1;
  if (player[idx] !== expected[idx]){
    loseGame("WRONG COLOR");
    return;
  }

  if (player.length === expected.length){
    stopTimer();
    isPlayerTurn = false;

    tickets += 1;
    sfxCheer();

    clearBonusBalloons();
    setStatus("Correct! +1 ticket. Next round...");
    updateHUD();

    const w = els.wheelSvg.getBoundingClientRect();
    confettiBurst(w.left + w.width/2, w.top + w.height/2, 140, 4.4);

    busy = true;
    setTimeout(() => { busy = false; advanceRound(); }, 650);
  }
}

/* Start new run */
async function startNewGame({ resetTickets }){
  if (gameActive || busy) return;

  ensureAudio();
  sfxCoin();

  buildSegments();
  renderWheel();

  rotationDeg = 0;
  els.rotator.style.transform = `rotate(${rotationDeg}deg)`;

  round = 0;
  sequence = [];
  expected = [];
  player = [];

  pendingTimeBonusMs = 0;
  if (resetTickets) tickets = 0;

  gameActive = true;
  clearBonusBalloons();

  stopTimer();
  updateHUD();

  setStatus("Get ready...");
  await wait(300);
  await advanceRound();
}

/* Toys list */
function renderAllToys(){
  sortShopItems();
  els.allToysGrid.innerHTML = "";

  for (const item of SHOP_ITEMS){
    const owned = prizesOwned.includes(item.id);

    const c = document.createElement("div");
    c.className = "toyMini";
    c.innerHTML = `
      <div class="toyMiniEmoji">${item.emoji}</div>
      <div class="toyMiniMid">
        <div class="toyMiniName">${item.name}</div>
        <div class="toyMiniDesc">${item.desc}</div>
      </div>
      <div class="toyMiniRight">
        <div class="toyMiniCost">${item.cost} üéüÔ∏è</div>
        ${owned ? `<span class="toyMiniOwned">Owned</span>` : ``}
      </div>
    `;
    els.allToysGrid.appendChild(c);
  }
}

/* Shop */
function openShop(){
  els.shopTickets.textContent = String(tickets);
  els.prizeCount.textContent = String(prizesOwned.length);
  els.shopBest.textContent = String(best);
  renderShopItems();
  els.shopModal.classList.remove("hidden");
}
function closeShop(){ els.shopModal.classList.add("hidden"); }

/* End = wipe */
function hardResetAllProgress(){
  prizesOwned = [];
  best = 0;
  tickets = 0;
  localStorage.removeItem("mcw_prizes_owned_carnival");
  localStorage.removeItem("mcw_best_carnival");
  updateHUD();
}
function goHomeEnd(){
  closeShop();
  hardResetAllProgress();
  showWelcome();
  resetCoinUI();
}

/* ‚úÖ End Congrats: show ONLY when ending */
function openEndCongrats(){
  els.endTickets.textContent = String(tickets);
  els.endPrizeCount.textContent = String(prizesOwned.length);
  els.endBest.textContent = String(best);

  const ownedItems = prizesOwned
    .map(id => SHOP_ITEMS.find(x => x.id === id))
    .filter(Boolean);

  els.endSub.textContent =
    ownedItems.length
      ? "Here are the prizes you collected üéâ"
      : "Thanks for playing!";

  els.endToysGrid.innerHTML = "";
  if (ownedItems.length){
    for (const it of ownedItems){
      const c = document.createElement("div");
      c.className = "endToy";
      c.innerHTML = `<div class="e">${it.emoji}</div><div class="n">${it.name}</div>`;
      els.endToysGrid.appendChild(c);
    }
  }

  els.endCongratsModal.classList.remove("hidden");
  confettiBurst(window.innerWidth * 0.5, window.innerHeight * 0.35, 220, 5.4);
}
function closeEndCongrats(){
  els.endCongratsModal.classList.add("hidden");
}

/* Continue from shop */
async function continueFromShop(){
  closeShop();
  await startNewGame({ resetTickets: false });
}

/* Prize fly animation */
function animatePrizeFly({ fromRect, toRect, emoji }){
  const el = document.createElement("div");
  el.textContent = emoji;
  el.style.position = "fixed";
  el.style.left = `${fromRect.left + fromRect.width/2}px`;
  el.style.top = `${fromRect.top + fromRect.height/2}px`;
  el.style.transform = "translate(-50%,-50%) scale(1)";
  el.style.fontSize = "40px";
  el.style.filter = "drop-shadow(0 14px 18px rgba(0,0,0,.35))";
  el.style.willChange = "transform,left,top,opacity";
  els.fxLayer.appendChild(el);

  const x0 = fromRect.left + fromRect.width/2;
  const y0 = fromRect.top + fromRect.height/2;
  const x1 = toRect.left + toRect.width/2;
  const y1 = toRect.top + toRect.height/2;

  const ctrlX = (x0 + x1) / 2 + (Math.random() * 80 - 40);
  const ctrlY = Math.min(y0, y1) - (90 + Math.random()*60);

  const dur = 520;
  const tStart = performance.now();

  function bezier(t, p0, p1, p2){
    const a = (1-t)*(1-t);
    const b = 2*(1-t)*t;
    const c = t*t;
    return a*p0 + b*p1 + c*p2;
  }
  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

  const step = (now) => {
    const raw = (now - tStart) / dur;
    const t = clamp(raw, 0, 1);
    const e = easeOutCubic(t);
    const x = bezier(e, x0, ctrlX, x1);
    const y = bezier(e, y0, ctrlY, y1);
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
    const s = 1 - e * 0.55;
    el.style.transform = `translate(-50%,-50%) scale(${s})`;
    el.style.opacity = String(1 - e * 0.15);

    if (t < 1){
      requestAnimationFrame(step);
    } else {
      el.remove();
      confettiBurst(x1, y1, 110, 4.6);
    }
  };
  requestAnimationFrame(step);
}

function renderShopItems(){
  sortShopItems();
  els.shopItems.innerHTML = "";

  for (const item of SHOP_ITEMS){
    const owned = prizesOwned.includes(item.id);

    const card = document.createElement("div");
    card.className = "shopItem";

    const name = document.createElement("div");
    name.className = "shopName";
    name.innerHTML = `<span class="shopEmoji">${item.emoji}</span> <span>${item.name}</span>`;

    const desc = document.createElement("div");
    desc.className = "shopDesc";
    desc.textContent = item.desc;

    const row = document.createElement("div");
    row.className = "shopBuyRow";

    const cost = document.createElement("div");
    cost.className = "shopCost";
    cost.textContent = `Cost: ${item.cost} tickets`;

    const btn = document.createElement("button");
    btn.className = "btn primary";
    btn.type = "button";
    btn.textContent = owned ? "Owned" : (tickets < item.cost ? "Need tickets" : "Buy");
    btn.disabled = owned || tickets < item.cost;

    btn.addEventListener("click", async () => {
      ensureAudio();
      if (owned || tickets < item.cost) return;

      tickets -= item.cost;
      prizesOwned.push(item.id);
      localStorage.setItem("mcw_prizes_owned_carnival", JSON.stringify(prizesOwned));
      sfxBell();

      updateHUD();
      renderShopItems();

      const fromRect = btn.getBoundingClientRect();
      const toRect = els.ownedCount.getBoundingClientRect();
      animatePrizeFly({ fromRect, toRect, emoji: item.emoji });
      confettiBurst(fromRect.left + fromRect.width/2, fromRect.top + fromRect.height/2, 140, 4.6);

      /* ‚úÖ No congrats popup on purchase anymore */
      setStatus(`Purchased: ${item.name} ‚úÖ`);
      await showBigMessage({ title: "PURCHASED!", sub: `${item.emoji} ${item.name}\nTickets left: ${tickets}`, ms: 900 });
    });

    row.appendChild(cost);
    row.appendChild(btn);

    card.appendChild(name);
    card.appendChild(desc);
    card.appendChild(row);

    els.shopItems.appendChild(card);
  }

  els.shopTickets.textContent = String(tickets);
  els.prizeCount.textContent = String(prizesOwned.length);
  els.shopBest.textContent = String(best);
}

/* HUD */
function updateHUD(){
  els.roundEl.textContent = String(round);
  els.bestEl.textContent = String(best);
  els.ticketsEl.textContent = String(tickets);
  els.ticketsChip.textContent = String(tickets);
  els.prizesEl.textContent = String(prizesOwned.length);
  els.ownedCount.textContent = String(prizesOwned.length);
  renderAllToys();
}

/* Sounds base */
function ensureAudio(){
  if (!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain();
    master.gain.value = 0.25;
    master.connect(audioCtx.destination);
  }
  if (audioCtx.state === "suspended") audioCtx.resume();
}
function tone(freq, t0, dur, type="sine", gain=0.25){
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, t0);
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
  o.connect(g).connect(master);
  o.start(t0);
  o.stop(t0 + dur + 0.02);
}
function sfxCoin(){
  const t = audioCtx.currentTime;
  tone(220, t, 0.10, "triangle", 0.18);
  tone(440, t + 0.06, 0.12, "triangle", 0.18);
  tone(660, t + 0.12, 0.10, "triangle", 0.14);
}
function sfxBell(){
  const t = audioCtx.currentTime;
  tone(880, t, 0.08, "sine", 0.16);
  tone(1320, t + 0.02, 0.10, "sine", 0.12);
  tone(1760, t + 0.04, 0.10, "sine", 0.10);
}
function sfxCheer(){
  const t = audioCtx.currentTime;
  tone(330, t, 0.18, "sawtooth", 0.08);
  tone(392, t + 0.05, 0.22, "sawtooth", 0.08);
  tone(523, t + 0.10, 0.25, "sawtooth", 0.08);
  tone(659, t + 0.16, 0.22, "sawtooth", 0.06);
}
function sfxBuzzer(){
  const t = audioCtx.currentTime;
  tone(110, t, 0.25, "square", 0.12);
  tone(92, t + 0.12, 0.30, "square", 0.10);
}

/* Coin drag-to-insert */
let dragging = false;
let ghost = null;
function rectsOverlap(a, b){
  return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom);
}
function setCoinInsertedState(on){
  coinInserted = on;
  els.coinSlotState.textContent = on ? "COIN INSERTED" : "NO COIN";
  els.startBtn.disabled = !on;
  els.startBtn.textContent = "Start Game";
}
function resetCoinUI(){
  if (ghost){ ghost.remove(); ghost = null; }
  dragging = false;
  els.coin.style.visibility = "visible";
  els.coinSlot.classList.remove("inserting");
  setCoinInsertedState(false);
}
function animateCoinIntoSlot(slotRect){
  if (!ghost) return;
  els.coinSlot.classList.add("inserting");

  const slitX = slotRect.left + slotRect.width / 2;
  const slitY = slotRect.top + slotRect.height * 0.46;

  ghost.classList.add("coinDrop");
  ghost.style.left = `${slitX}px`;
  ghost.style.top = `${slitY}px`;

  setTimeout(() => {
    if (!ghost) return;
    requestAnimationFrame(() => {
      ghost.style.top = `${slitY + 26}px`;
      ghost.style.transform = "translate(-50%,-50%) scale(0.10)";
      ghost.style.opacity = "0";
      ghost.style.filter = "blur(1.2px)";
    });
  }, 140);

  setTimeout(() => {
    if (ghost){ ghost.remove(); ghost = null; }
    els.coin.style.visibility = "hidden";
    els.coinSlot.classList.remove("inserting");
    setCoinInsertedState(true);
    setStatus("Coin accepted. Press Start Game.");
    ensureAudio(); sfxCoin();
    const r = els.coinSlot.getBoundingClientRect();
    confettiBurst(r.left + r.width/2, r.top + r.height/2, 80, 4.0);
  }, 520);
}
function onCoinPointerDown(e){
  if (coinInserted) return;
  e.preventDefault();
  dragging = true;

  ghost = els.coin.cloneNode(true);
  ghost.classList.add("coinGhost");
  ghost.removeAttribute("id");
  document.body.appendChild(ghost);

  els.coin.style.visibility = "hidden";

  const move = (ev) => {
    if (!dragging || !ghost) return;
    ghost.style.left = `${ev.clientX}px`;
    ghost.style.top = `${ev.clientY}px`;
  };
  const up = (ev) => {
    if (!dragging) return;
    dragging = false;

    if (ghost){
      ghost.style.left = `${ev.clientX}px`;
      ghost.style.top = `${ev.clientY}px`;

      const coinRect = ghost.getBoundingClientRect();
      const slotRect = els.coinSlot.getBoundingClientRect();

      window.removeEventListener("pointermove", move);
      window.removeEventListener("pointerup", up);
      window.removeEventListener("pointercancel", up);

      if (rectsOverlap(coinRect, slotRect)){
        animateCoinIntoSlot(slotRect);
      } else {
        ghost.remove();
        ghost = null;
        els.coin.style.visibility = "visible";
      }
    }
  };

  window.addEventListener("pointermove", move, { passive: false });
  window.addEventListener("pointerup", up, { passive: false });
  window.addEventListener("pointercancel", up, { passive: false });
}

/* Confetti */
const conf = { ctx: null, w: 0, h: 0, running: false, parts: [] };
function resizeConfettiCanvas(){
  const dpr = window.devicePixelRatio || 1;
  conf.w = window.innerWidth;
  conf.h = window.innerHeight;
  els.confetti.width = Math.floor(conf.w * dpr);
  els.confetti.height = Math.floor(conf.h * dpr);
  els.confetti.style.width = conf.w + "px";
  els.confetti.style.height = conf.h + "px";
  conf.ctx = els.confetti.getContext("2d");
  conf.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
function confettiBurst(x, y, count=120, power=4.2){
  const colors = SLICE_COLORS;
  for (let i=0; i<count; i++){
    const a = Math.random() * Math.PI * 2;
    const sp = (Math.random() * 0.85 + 0.15) * (power * 2.6);
    conf.parts.push({
      x, y,
      vx: Math.cos(a) * sp + (Math.random()*1.2 - 0.6),
      vy: Math.sin(a) * sp - (power * 1.3),
      g: 0.14 + Math.random()*0.12,
      r: Math.random()*Math.PI*2,
      vr: (Math.random()*0.25 - 0.125),
      w: 3 + Math.random()*5,
      h: 6 + Math.random()*10,
      life: 58 + Math.floor(Math.random()*35),
      color: colors[(Math.random()*colors.length)|0],
      alpha: 1
    });
  }
  if (!conf.running) runConfetti();
}
function runConfetti(){
  conf.running = true;
  const tick = () => {
    const ctx = conf.ctx;
    if (!ctx){ conf.running = false; return; }
    ctx.clearRect(0,0,conf.w,conf.h);

    for (let i=conf.parts.length-1; i>=0; i--){
      const p = conf.parts[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.g;
      p.r += p.vr;
      p.life -= 1;
      p.alpha = clamp(p.life / 65, 0, 1);

      ctx.save();
      ctx.globalAlpha = p.alpha;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.r);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();

      if (p.life <= 0 || p.y > conf.h + 80){
        conf.parts.splice(i, 1);
      }
    }

    if (conf.parts.length){
      requestAnimationFrame(tick);
    } else {
      conf.running = false;
      ctx.clearRect(0,0,conf.w,conf.h);
    }
  };
  requestAnimationFrame(tick);
}

/* Events */
els.welcomeNextBtn.addEventListener("click", () => {
  showInstructionsPage();
  const r = els.welcomeNextBtn.getBoundingClientRect();
  confettiBurst(r.left + r.width/2, r.top + r.height/2, 120, 4.6);
});
els.welcomeBackBtn.addEventListener("click", () => showWelcomePage());

els.startBtn.addEventListener("click", async () => {
  if (!coinInserted) return;
  hideWelcome();
  await startNewGame({ resetTickets: true });
});

/* ‚úÖ End button now shows congrats ONLY when ending */
els.backToHomeBtn.addEventListener("click", () => {
  closeShop();
  if (prizesOwned.length > 0){
    openEndCongrats();
  } else {
    goHomeEnd();
  }
});
els.endBackToWelcomeBtn.addEventListener("click", () => {
  closeEndCongrats();
  goHomeEnd();
});

els.shopContinueBtn.addEventListener("click", () => continueFromShop());
els.coin.addEventListener("pointerdown", onCoinPointerDown, { passive: false });

els.wheelSvg.addEventListener("click", (e) => {
  const target = e.target;
  if (!(target instanceof SVGPathElement)) return;
  if (!target.classList.contains("slice")) return;
  onPlayerPick(Number(target.dataset.slice));
});

/* Init */
function init(){
  resizeConfettiCanvas();

  buildStars();     // ‚úÖ stars
  buildFlags();
  buildTwinkles();
  buildSparkles();

  spawnBackgroundBalloons();
  buildWheelLights();
  buildSegments();
  renderWheel();
  setHourglass(1);
  updateHUD();
  resetCoinUI();
  clearBonusBalloons();
  showWelcome();

  requestAnimationFrame(() => {
    applyAppScale();
    requestAnimationFrame(applyAppScale);
  });
}
init();
  </script>
</body>
</html>
