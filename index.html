<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Color Memory Wheel</title>

  <style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Protest+Revolution&family=Cinzel+Decorative:wght@700&family=Molle:ital@1&family=Bonheur+Royale&family=Playball&family=Spicy+Rice&family=Mystery+Quest&family=Ultra&display=swap');

:root{
  --text: rgba(255,255,255,.95);
  --muted: rgba(255,255,255,.78);
  --shadow: 0 18px 50px rgba(0,0,0,.45);
  --appScale: 1;
  --flagSize: clamp(18px, 2.4vw, 30px);
}

*{ box-sizing: border-box; }
html, body{ height: 100%; }
html { touch-action: manipulation; }

body{
  margin: 0;
  height: 100vh;
  overflow: hidden;
  color: var(--text);
  font-family: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background:
    radial-gradient(1200px circle at 20% 10%, rgba(255,255,255,0.18), transparent 60%),
    radial-gradient(900px circle at 80% 0%, rgba(255,0,150,0.16), transparent 65%),
    radial-gradient(900px circle at 80% 60%, rgba(0,255,200,0.12), transparent 60%),
    linear-gradient(180deg, #2a0a2b 0%, #0b1f46 60%, #071226 100%);
}
body::before{
  content:"";
  position: fixed;
  inset: 0;
  pointer-events: none;
  background:
    repeating-linear-gradient(
      135deg,
      rgba(255,47,75,.12) 0px,
      rgba(255,47,75,.12) 26px,
      rgba(255,255,255,.05) 26px,
      rgba(255,255,255,.05) 52px
    );
  mix-blend-mode: overlay;
  opacity: .42;
}

/* ===== Background starbursts ===== */
#stars{
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}
.star{
  position: absolute;
  left: var(--x);
  top: var(--y);
  width: var(--s);
  height: var(--s);
  border-radius: 999px;
  transform: translate(-50%,-50%) scale(.92);
  opacity: .14;

  background:
    radial-gradient(circle, rgba(255,255,255,.98) 0%,
                            rgba(255,244,210,.96) 10%,
                            rgba(255,220,140,.75) 24%,
                            rgba(255,200,90,.35) 42%,
                            transparent 68%),
    repeating-conic-gradient(from 0deg,
      rgba(255,235,180,.55) 0 1.1deg,
      transparent 1.1deg 8.5deg),
    linear-gradient(90deg,
      transparent 0 46%,
      rgba(255,230,170,.50) 50%,
      transparent 54%),
    linear-gradient(0deg,
      transparent 0 46%,
      rgba(255,230,170,.50) 50%,
      transparent 54%),
    linear-gradient(45deg,
      transparent 0 47%,
      rgba(255,230,170,.26) 50%,
      transparent 53%),
    linear-gradient(-45deg,
      transparent 0 47%,
      rgba(255,230,170,.26) 50%,
      transparent 53%);

  box-shadow:
    0 0 8px rgba(255,220,140,.22),
    0 0 16px rgba(255,200,90,.12);
  filter: blur(.10px);
  will-change: transform, opacity, filter;
  animation: starTwinkle var(--t) ease-in-out infinite;
  animation-delay: var(--d);
}
@keyframes starTwinkle{
  0%,100%{ opacity:.12; transform: translate(-50%,-50%) scale(.90); filter: brightness(.98) blur(.10px); }
  50%{ opacity:.82; transform: translate(-50%,-50%) scale(1.06); filter: brightness(1.18) blur(.10px); }
}

/* ===== Balloons (CIRCULAR) ===== */
#balloons{
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 0;
}
.balloon{
  position: absolute;
  left: var(--x);
  bottom: -24vh;

  width: var(--w);
  height: var(--w);
  border-radius: 999px;

  background:
    radial-gradient(circle at 30% 22%, rgba(255,255,255,.55), rgba(255,255,255,0) 44%),
    radial-gradient(circle at 55% 80%, rgba(0,0,0,.18), rgba(0,0,0,0) 55%),
    hsla(var(--h), 85%, 60%, 0.88);

  box-shadow:
    inset 0 -18px 24px rgba(0,0,0,.15),
    inset 0 16px 22px rgba(255,255,255,.18);

  filter: drop-shadow(0 14px 16px rgba(0,0,0,.18));
  animation: floatUp var(--t) linear forwards;
  opacity: 0;
  will-change: transform, opacity;
}
.balloon .string{
  position: absolute;
  left: 50%;
  top: calc(100% + 4px);
  transform: translateX(-50%);
  width: 2px;
  height: var(--s);
  background: rgba(255,255,255,.26);
  border-radius: 2px;
  opacity: .9;
}
@keyframes floatUp{
  0%{ transform: translateY(0) rotate(-2deg); opacity: 0; }
  8%{ opacity: .78; }
  100%{ transform: translateY(-140vh) rotate(2deg); opacity: 0; }
}

/* FX layers */
#confetti{
  position: fixed;
  inset: 0;
  z-index: 60;
  pointer-events: none;
}
#fxLayer{
  position: fixed;
  inset: 0;
  z-index: 61;
  pointer-events: none;
}

/* Auto-fit scale root */
#scaleRoot{
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(var(--appScale));
  transform-origin: center;
  z-index: 1;
  width: min(1440px, 98vw);
}

/* App layout */
.app{
  width: 100%;
  height: calc(100vh - 8px);
  padding: 6px 0;
  display: grid;
  grid-template-rows: 1fr auto;
  gap: 8px;
}

.stage{
  display: grid;
  grid-template-columns:
    clamp(240px, 22vw, 330px)
    1fr
    clamp(240px, 22vw, 330px);
  gap: 12px;
  align-items: start;
  min-height: 0;
  height: 100%;
}

/* Side panels scroll internally */
.leftPanel, .rightPanel{
  display: grid;
  gap: 10px;
  min-height: 0;
  overflow: hidden;
  padding-right: 4px;
}
.panelTitle{
  font-family: "Protest Revolution", "Inter", system-ui;
  font-weight: 400;
  font-size: 20px;
  letter-spacing: .6px;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
  text-align: center;
}
.leftPanelInner, .rightPanelInner{
  display: grid;
  gap: 10px;
  min-height: 0;
  overflow: auto;
  padding-right: 2px;
}

/* Center */
.centerCol{ display: grid; gap: 10px; justify-items: center; min-height: 0; }
.centerHeader{
  position: relative;
  text-align: center;
  padding: 10px 12px;
  border-radius: 18px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: var(--shadow);
  width: min(900px, 100%);
}

/* Music toggle button for left panel */
.musicToggleBtn{
  background: rgba(255,255,255,.06);
  color: var(--text);
  border: 1px solid rgba(255,255,255,.08);
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 14px;
  display: inline-block;
}
.musicToggleBtn:hover{ filter: brightness(1.08); }
.musicToggleBtn:active{ transform: translateY(0); }

/* Music volume slider */
.musicVolume{
  width: 160px;
  background: transparent;
  -webkit-appearance: none;
}
.musicVolume:focus{ outline: none; }

/* track */
.musicVolume::-webkit-slider-runnable-track{
  height: 8px; border-radius: 8px; background: linear-gradient(90deg,#ff8acb 0%, #9ad1ff 100%);
}
.musicVolume::-moz-range-track{
  height: 8px; border-radius: 8px; background: linear-gradient(90deg,#ff8acb 0%, #9ad1ff 100%);
}
.musicVolume::-webkit-slider-thumb{
  -webkit-appearance: none;
  margin-top: -3px; /* center thumb */
  height: 14px; width: 14px; border-radius: 50%; background: #ff8acb; box-shadow: 0 2px 4px rgba(0,0,0,.28);
}
.musicVolume::-moz-range-thumb{
  height: 14px; width:14px; border-radius:50%; background:#ff8acb; box-shadow: 0 2px 4px rgba(0,0,0,.28);
}
.musicVolLabel{ cursor: pointer; user-select: none; font-size:13px; color: var(--muted); }


/* Glow pulse */
@keyframes textGlowPulse{
  0%,100%{ filter: drop-shadow(0 0 10px rgba(255,255,255,.14)) drop-shadow(0 0 18px rgba(255,255,255,.06)); }
  50%{ filter: drop-shadow(0 0 14px rgba(255,255,255,.20)) drop-shadow(0 0 24px rgba(255,255,255,.10)); }
}

/* Congrats rainbow gradient */
@keyframes rainbowShift{
  0%{ background-position: 0% 50%; }
  100%{ background-position: 100% 50%; }
}
.rainbowCongrats{
  background-image: linear-gradient(90deg,
    #ff8acb,
    #9ad1ff,
    #a7f4ff,
    #b8ffb1,
    #ffe08a,
    #ffb07a,
    #d2a6ff,
    #ff8acb
  );
  background-size: 240% 100%;
  background-position: 0% 50%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  padding: 0 10px;

  filter:
    drop-shadow(0 0 14px rgba(255,255,255,.16))
    drop-shadow(0 0 22px rgba(255,255,255,.08));
  text-shadow: 0 18px 40px rgba(0,0,0,.55);

  animation: rainbowShift 4.0s linear infinite;
}

/* During game title */
.centerTitle{
  font-family: "Cinzel Decorative", serif;
  font-weight: 700;
  font-size: clamp(22px, 2.7vw, 40px);
  letter-spacing: 1.1px;
  text-transform: uppercase;

  display: inline-flex;
  justify-content: center;
  align-items: baseline;
  gap: 10px;
  flex-wrap: wrap;
  white-space: normal;
  line-height: 1.15;
  max-width: 100%;
  animation: textGlowPulse 2.6s ease-in-out infinite;
}
.centerSubtitle{
  margin-top: 4px;
  font-weight: 400;
  color: rgba(255,255,255,.92);
  letter-spacing: .2px;
  font-family: "Bonheur Royale", cursive;
  font-size: clamp(20px, 2.4vw, 30px);
  text-shadow: 0 0 12px rgba(255,255,255,.14), 0 12px 26px rgba(0,0,0,.32);
}
.oneLine{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* HUD */
.hudGrid{ display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.stat{
  padding: 10px;
  border-radius: 16px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 10px 24px rgba(0,0,0,.18);
}
.statLabel{ font-size: 12px; color: var(--muted); font-weight: 800; }
.statValue{ font-size: 20px; font-weight: 900; }

.panel{
  padding: 12px;
  border-radius: 18px;
  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: var(--shadow);
  min-height: 0;
}
.status{ font-weight: 800; font-size: 13px; line-height: 1.35; margin-bottom: 10px; }
.rows{ display: grid; gap: 10px; margin-bottom: 10px; }
.row{ display: grid; gap: 7px; }
.rowLabel{ font-size: 12px; color: var(--muted); font-weight: 800; }

.pips{ display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px; }
.pip{
  width: 26px;
  height: 26px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  box-shadow: 0 10px 22px rgba(0,0,0,.18);
}
.pip.slot{ background: rgba(255,255,255,.06); border-style: dashed; box-shadow: none; }
.hint{ font-size: 13px; color: rgba(255,255,255,.80); }

/* Bonus */
.bonusWrap{ margin: 10px 0 8px; display: grid; gap: 8px; }
.bonusLabel{ font-size: 12px; color: rgba(255,255,255,.86); font-weight: 900; }
.bonusBalloons{ display: flex; gap: 12px; flex-wrap: wrap; min-height: 62px; align-items: flex-end; }
.bonusBtn{
  pointer-events: auto;
  cursor: pointer;
  user-select: none;
  border: none;
  color: rgba(255,255,255,.98);
  font-weight: 1000;
  box-shadow: 0 12px 22px rgba(0,0,0,.20);
  transition: transform .06s linear, filter .06s linear, opacity .10s linear;
  touch-action: manipulation;
}
.bonusBtn:hover{ filter: brightness(1.08); transform: translateY(-1px) scale(1.01); }
.bonusBtn:active{ transform: translateY(0px) scale(1.00); }
.bonusBtn.pop{ opacity: 0; transform: scale(.7); pointer-events: none; }

/* Bonus balloon circular too */
.bonusBalloonCircle{
  position: relative;
  width: 84px;
  height: 84px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.26);
  background:
    radial-gradient(circle at 30% 22%, rgba(255,255,255,.52), rgba(255,255,255,0) 44%),
    radial-gradient(circle at 55% 80%, rgba(0,0,0,.16), rgba(0,0,0,0) 55%),
    hsla(var(--h), 85%, 60%, 0.94);
  box-shadow: inset 0 -16px 18px rgba(0,0,0,.16), 0 12px 22px rgba(0,0,0,.20), 0 0 12px hsla(var(--h), 90%, 60%, .20);
  display: grid;
  place-items: center;
  padding: 0;
  text-shadow: 0 10px 20px rgba(0,0,0,.35);
}
.bonusBalloonCircle .string{
  position: absolute;
  left: 50%;
  top: calc(100% + 4px);
  transform: translateX(-50%);
  width: 2px;
  height: 40px;
  background: rgba(255,255,255,.26);
  border-radius: 2px;
}
.bonusBalloonCircle .big{ font-size: 18px; letter-spacing: .2px; }
.bonusBalloonCircle .small{ margin-top: 2px; font-size: 10px; letter-spacing: .9px; opacity: .92; }

.bonusTicket{
  position: relative;
  width: 118px;
  height: 54px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.26);
  background:
    radial-gradient(circle at 20% 25%, rgba(255,255,255,.34), rgba(255,255,255,0) 44%),
    linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.06));
  box-shadow: inset 0 -14px 18px rgba(0,0,0,.16), 0 12px 22px rgba(0,0,0,.20);
  display: grid;
  place-items: center;
  padding: 0 10px;
  overflow: hidden;
}
.bonusTicket::before,
.bonusTicket::after{
  content:"";
  position: absolute;
  top: 50%;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.10);
  transform: translateY(-50%);
}
.bonusTicket::before{ left: -12px; }
.bonusTicket::after{ right: -12px; }
.bonusTicket .ticketInner{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  letter-spacing: .5px;
  text-shadow: 0 10px 20px rgba(0,0,0,.35);
}
.bonusTicket .ticketIcon{
  font-size: 18px;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
}

/* Wheel */
.wheelWrap{
  position: relative;

  /* âœ… BIGGER wheel */
  --wheelSize: min(1800px, 98vmin, 99vw, calc(100vh - 140px));
  width: var(--wheelSize);
  height: var(--wheelSize);

  margin: 0 auto 6px;
  border-radius: 22px;

  /* slightly tighter padding so the actual wheel can be bigger */
  padding: clamp(8px, 1.3vmin, 14px);

  background: rgba(0,0,0,.18);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: var(--shadow);
  contain: layout paint;
}
.pointer{
  position: absolute;
  top: 8px;
  left: 50%;
  transform: translateX(-50%);
  width: 0; height: 0;
  border-left: 16px solid transparent;
  border-right: 16px solid transparent;
  border-bottom: 28px solid rgba(255,255,255,.95);
  filter: drop-shadow(0 10px 14px rgba(0,0,0,.32));
  z-index: 8;
}
.rotator{
  width: 100%;
  height: 100%;
  border-radius: 999px;
  overflow: hidden;
  display: grid;
  place-items: center;
  transition: transform 3400ms cubic-bezier(.18,.88,.1,1);
  will-change: transform;
}
#wheelSvg{
  width: 100%;
  height: 100%;
  display: block;
  filter: drop-shadow(0 14px 16px rgba(0,0,0,.26));
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}

/* Instant feeling taps */
.slice{
  stroke: rgba(255,255,255,.22);
  stroke-width: 2;
  cursor: pointer;
  transition: opacity 0ms linear, stroke-width 0ms linear;
  filter: none;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  will-change: filter;
}
.slice:hover{
  filter:
    drop-shadow(0 0 10px color-mix(in srgb, var(--glow) 85%, transparent))
    drop-shadow(0 0 16px color-mix(in srgb, var(--glow) 55%, transparent));
}
.slice:active{
  filter:
    drop-shadow(0 0 12px color-mix(in srgb, var(--glow) 90%, transparent))
    drop-shadow(0 0 20px color-mix(in srgb, var(--glow) 60%, transparent));
}

/* Dim fix */
#wheelSvg.dimAll .slice{ opacity: .18; }
#wheelSvg.dimAll .slice.activeFlash{ opacity: 1; }

/* Lights around wheel */
.wheelLights{
  position: absolute;
  inset: 8px;
  border-radius: 999px;
  pointer-events: none;
  z-index: 7;
}
.wheelBulb{
  position: absolute;
  width: 16px;
  height: 16px;
  border-radius: 999px;
  background: rgba(255,255,255,.90);
  box-shadow: 0 0 10px rgba(255,255,255,.70), 0 0 18px rgba(255,255,255,.30);
  opacity: .90;
  animation: wheelTwinkle 2.4s ease-in-out infinite;
  animation-delay: var(--d);
  will-change: transform, opacity;
}
@keyframes wheelTwinkle{
  0%,100%{ transform: translate(-50%,-50%) scale(1); opacity: .86; filter: brightness(.98); }
  50%{ transform: translate(-50%,-50%) scale(1.08); opacity: 1; filter: brightness(1.18); }
}

/* Center hourglass */
.centerOverlay{
  position: absolute;
  inset: 0;
  display: grid;
  place-items: center;
  pointer-events: none;
  z-index: 9;
}
.centerGlass{
  width: 150px;
  height: 150px;
  border-radius: 999px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 16px 34px rgba(0,0,0,.32);
  display: grid;
  place-items: center;
  gap: 6px;
}
.hg{ width: 74px; height: 74px; }
.hgGlass{ fill: rgba(255,255,255,.06); stroke: rgba(255,255,255,.82); stroke-width: 3; }
.hgSand{ fill: rgba(255, 221, 120, .95); }
.hgNeck{ stroke: rgba(255,255,255,.9); stroke-width: 4; stroke-linecap: round; }
.timerText{ font-weight: 900; font-size: 14px; color: rgba(255,255,255,.95); }

/* Chips */
.shopChip{
  padding: 8px 12px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
  border: 1px dashed rgba(255,255,255,.18);
  font-weight: 900;
}
.shopChip .k{ color: rgba(255,255,255,.78); }

/* Prize Toys list */
.allToysGrid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  min-height: 0;
  padding-bottom: 4px;
}
.toyMini{
  border-radius: 16px;
  padding: 8px 9px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 10px 22px rgba(0,0,0,.16);
  display: grid;
  grid-template-columns: 38px 1fr;
  gap: 8px;
  align-items: center;
  min-width: 0;
}
.toyMiniEmoji{
  width: 38px;
  height: 38px;
  border-radius: 12px;
  display: grid;
  place-items: center;
  font-size: 22px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.12);
}
.toyMiniMid{ display: grid; gap: 2px; min-width: 0; }
.toyMiniName{
  font-weight: 1000;
  font-size: 11px;
  line-height: 1.1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.toyMiniDesc{
  font-size: 10px;
  line-height: 1.15;
  color: rgba(255,255,255,.78);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Buttons */
.btn{
  border: 1px dashed rgba(255,255,255,.28);
  background: rgba(255,255,255,.10);
  color: var(--text);
  padding: 10px 14px;
  border-radius: 14px;
  cursor: pointer;
  box-shadow: 0 10px 25px rgba(0,0,0,.22);
  transition: transform .06s linear, filter .06s linear, opacity .10s linear;
  user-select: none;
  font-weight: 900;
  touch-action: manipulation;
}
.btn:hover{ filter: brightness(1.08); }
.btn:active{ transform: translateY(1px) scale(.99); }
.btn:disabled{ opacity: .40; cursor: not-allowed; filter: none; }
.btn.primary{
  background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.08));
  border-color: rgba(255,255,255,.34);
}
.bigBtn{ width: 100%; padding: 14px 16px; font-size: 15px; }

.glowBtn{ position: relative; overflow: hidden; }
.glowBtn::after{
  content:"";
  position: absolute;
  inset: -60px;
  background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), transparent 45%);
  transform: translateX(-40%);
  animation: sheen 2.4s ease-in-out infinite;
  pointer-events: none;
}
@keyframes sheen{
  0%{ transform: translateX(-60%); opacity: .30; }
  50%{ opacity: .65; }
  100%{ transform: translateX(60%); opacity: .30; }
}

/* Modals */
.modal{
  position: fixed;
  inset: 0;
  z-index: 50;
  display: grid;
  place-items: center;
  background: rgba(0,0,0,.60);
  padding: 18px;
}
.modal.hidden{ display: none; }
.modal.show{ display: grid; }
.modalCard{
  width: min(680px, 94vw);
  border-radius: 20px;
  padding: 18px;
  background: rgba(0,0,0,.30);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: var(--shadow);
  overflow: hidden;
}
.modalCard.wide{ width: min(980px, 94vw); overflow: hidden; }

.modalTitle{
  margin: 0 0 4px 0;
  font-family: "Protest Revolution", "Inter", system-ui;
  font-size: clamp(26px, 3.4vw, 40px);
  font-weight: 400;
  text-align: center;
  letter-spacing: .7px;
}
.modalSub{
  margin: 0 0 14px 0;
  color: rgba(255,255,255,.82);
  font-weight: 900;
  text-align: center;
}
.modalNav{
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 6px;
}
.hiddenPage{ display: none; }

/* WELCOME (unchanged from your last version) */
.welcomeWrap{ text-align: center; display: grid; gap: 14px; }
.nmHero{
  position: relative;
  border-radius: 22px;
  padding: 16px;
  border: 1px solid rgba(255,255,255,.16);
  background:
    radial-gradient(900px circle at 50% 0%, rgba(255,255,255,.14), transparent 55%),
    radial-gradient(900px circle at 15% 40%, rgba(255,170,60,.12), transparent 60%),
    radial-gradient(900px circle at 85% 40%, rgba(255,0,170,.10), transparent 60%),
    linear-gradient(180deg, rgba(6,10,30,.62), rgba(0,0,0,.20));
  box-shadow: 0 20px 70px rgba(0,0,0,.48);
  overflow: hidden;
}
.nmHero::before{
  content:"";
  position:absolute; inset:-60px;
  background:
    radial-gradient(circle at 20% 30%, rgba(0,255,220,.14), transparent 45%),
    radial-gradient(circle at 80% 35%, rgba(255,70,200,.14), transparent 48%),
    radial-gradient(circle at 55% 10%, rgba(255,220,120,.12), transparent 45%);
  opacity: .85;
  animation: nmGlow 7.0s ease-in-out infinite;
  pointer-events:none;
}
@keyframes nmGlow{
  0%,100%{ transform: translate3d(-16px,-6px,0) scale(1.02); opacity:.72; }
  50%{ transform: translate3d(16px,10px,0) scale(1.05); opacity:1; }
}
.twinkleLayer{ position: absolute; inset: 0; pointer-events: none; z-index: 1; }
.twStar{
  position: absolute; left: var(--x); top: var(--y);
  width: var(--s); height: var(--s);
  border-radius: 999px;
  transform: translate(-50%,-50%) scale(.9);
  opacity: .12;
  background:
    radial-gradient(circle, rgba(255,255,255,.98) 0%,
                            rgba(255,244,210,.95) 10%,
                            rgba(255,220,140,.70) 24%,
                            rgba(255,200,90,.32) 42%,
                            transparent 68%),
    repeating-conic-gradient(from 0deg,
      rgba(255,235,180,.55) 0 1.2deg,
      transparent 1.2deg 9deg),
    linear-gradient(90deg, transparent 0 46%, rgba(255,230,170,.40) 50%, transparent 54%),
    linear-gradient(0deg,  transparent 0 46%, rgba(255,230,170,.40) 50%, transparent 54%);
  box-shadow: 0 0 10px rgba(255,220,140,.18), 0 0 18px rgba(255,200,90,.10);
  filter: blur(.12px);
  will-change: transform, opacity, filter;
  animation: twinkle var(--t) ease-in-out infinite;
  animation-delay: var(--d);
}
@keyframes twinkle{
  0%,100%{ opacity:.12; transform: translate(-50%,-50%) scale(.90); filter: brightness(.98) blur(.12px); }
  50%{ opacity:.88; transform: translate(-50%,-50%) scale(1.10); filter: brightness(1.18) blur(.12px); }
}
.sparkles{ position:absolute; inset:0; pointer-events:none; z-index: 1; }
.sparkle{
  position:absolute;
  left: var(--x); top: var(--y);
  width: var(--s); height: var(--s);
  border-radius: 999px;
  transform: translate(-50%,-50%) scale(.9);
  opacity: .0;
  background:
    radial-gradient(circle, rgba(255,255,255,.98) 0%,
                            rgba(255,244,210,.90) 12%,
                            rgba(255,220,140,.55) 28%,
                            transparent 66%),
    repeating-conic-gradient(from 0deg, rgba(255,235,180,.50) 0 1.1deg, transparent 1.1deg 10deg);
  box-shadow: 0 0 12px rgba(255,255,255,.18);
  filter: blur(.10px);
  will-change: transform, opacity;
  animation: sparklePop var(--t) ease-in-out infinite;
  animation-delay: var(--d);
}
@keyframes sparklePop{
  0%{ transform: translate(-50%,-50%) scale(.60); opacity:0; }
  20%{ opacity:.90; }
  50%{ transform: translate(-50%,-50%) scale(1.12); opacity:.65; }
  100%{ transform: translate(-50%,-50%) scale(.75); opacity:0; }
}
.flagRow{ position: relative; z-index: 2; display: grid; gap: 8px; margin-bottom: 10px; }
.flagString{
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.10);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 10px 18px rgba(0,0,0,.18);
  opacity: .9;
}
.flagsWrap{ display: grid; gap: 8px; }
.flagsLine{
  display: grid;
  grid-template-columns: repeat(16, var(--flagSize));
  gap: 8px;
  justify-content: center;
  align-content: center;
}
.flag{
  width: var(--flagSize);
  height: calc(var(--flagSize) * 0.93);
  clip-path: polygon(0 0, 100% 0, 50% 100%);
  background:
    radial-gradient(circle at 30% 20%, rgba(255,255,255,.36), rgba(255,255,255,0) 44%),
    hsla(var(--h), 92%, 60%, .98);
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 10px 18px rgba(0,0,0,.24), 0 0 14px hsla(var(--h), 90%, 60%, .12);
  transform-origin: 50% 0%;
  animation: flagWiggle 1.7s ease-in-out infinite;
  animation-delay: var(--d);
  will-change: transform;
}
@keyframes flagWiggle{
  0%,100%{ transform: rotate(-3deg) translateY(0); }
  50%{ transform: rotate(3deg) translateY(1px); }
}
.neonSign{
  position: relative;
  z-index: 2;
  border-radius: 22px;
  padding: 18px 18px 16px;
  margin: 6px auto 10px;
  width: min(620px, 100%);
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.16);
  box-shadow:
    0 18px 55px rgba(0,0,0,.45),
    0 0 0 2px rgba(255,255,255,.06) inset;
  overflow: visible;
}
.neonSign::before{
  content:"";
  position:absolute; inset:-120px;
  background: radial-gradient(circle at 30% 35%, rgba(255,120,40,.14), transparent 52%),
              radial-gradient(circle at 75% 35%, rgba(255,0,200,.12), transparent 54%),
              radial-gradient(circle at 50% 10%, rgba(0,255,220,.10), transparent 52%);
  animation: neonWash 5.8s ease-in-out infinite;
  pointer-events:none;
}
@keyframes neonWash{
  0%,100%{ transform: translateX(-16px) translateY(-8px); opacity:.78; }
  50%{ transform: translateX(16px) translateY(8px); opacity:1; }
}
.neonKicker{
  font-weight: 900;
  letter-spacing: .9px;
  color: rgba(255,255,255,.86);
  text-transform: uppercase;
  font-size: 12px;
}
.neonTitle{
  margin: 6px 0 0;
  font-family: "Cinzel Decorative", serif;
  font-weight: 700;
  font-size: clamp(22px, 3.6vw, 44px);
  line-height: 1.15;
  letter-spacing: 1.0px;
  text-transform: uppercase;
  display: inline-flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
  white-space: normal;
  animation: textGlowPulse 2.6s ease-in-out infinite;
}
.neonSub{
  margin: 10px auto 0;
  color: rgba(255,255,255,.92);
  max-width: 60ch;
  line-height: 1.15;
  font-family: "Bonheur Royale", cursive;
  font-weight: 400;
  font-size: clamp(22px, 3.2vw, 34px);
  letter-spacing: .2px;
  text-shadow: 0 0 12px rgba(255,255,255,.18), 0 10px 22px rgba(0,0,0,.35);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.nmIcons{
  position: relative;
  z-index: 2;
  display:flex;
  justify-content:center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.nmChip{
  border-radius: 999px;
  padding: 8px 10px;
  font-weight: 900;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  animation: floatIcon 3.2s ease-in-out infinite;
  will-change: transform;
}
.nmChip:nth-child(2){ animation-delay: .2s; }
.nmChip:nth-child(3){ animation-delay: .4s; }
@keyframes floatIcon{
  0%,100%{ transform: translateY(0); }
  50%{ transform: translateY(-3px); }
}
.welcomeCTA{ display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

/* Coin UI */
.coinArea{
  margin: 10px 0 12px;
  padding: 12px;
  border-radius: 16px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.12);
  display: grid;
  gap: 10px;
}
.coinHint{ font-size: 12px; color: rgba(255,255,255,.82); font-weight: 900; text-align: center; }
.coinRow{ display: grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items: center; }
.coinSlot{
  position: relative;
  height: 86px;
  border-radius: 16px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 14px 30px rgba(0,0,0,.25);
  overflow: hidden;
}
.coinMouth{
  position: absolute;
  left: 50%;
  top: 46%;
  transform: translate(-50%,-50%);
  width: 70%;
  height: 16px;
  border-radius: 999px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: inset 0 2px 10px rgba(0,0,0,.70);
}
.coinMouth::after{
  content:"";
  position: absolute;
  inset: 2px 6px;
  border-radius: 999px;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,0));
  opacity: .45;
}
.coinSlot.inserting .coinMouth{ filter: drop-shadow(0 0 12px rgba(255,255,255,.10)); }
.coinSlotLabel{
  position: absolute;
  bottom: 10px;
  width: 100%;
  text-align: center;
  font-size: 11px;
  color: rgba(255,255,255,.78);
  font-weight: 900;
  letter-spacing: .6px;
}
.coinSlotState{
  position: absolute;
  top: 10px;
  width: 100%;
  text-align: center;
  font-size: 11px;
  color: rgba(255,255,255,.86);
  font-weight: 900;
  letter-spacing: .5px;
}
.coinPad{
  position: relative;
  height: 86px;
  border-radius: 16px;
  background: rgba(0,0,0,.18);
  border: 1px dashed rgba(255,255,255,.18);
  display: grid;
  place-items: center;
}

/* Gold coin */
.coin{
  width: 62px;
  height: 62px;
  border-radius: 999px;
  background:
    radial-gradient(circle at 30% 25%, rgba(255,255,255,.68), rgba(255,255,255,0) 42%),
    radial-gradient(circle at 50% 70%, rgba(0,0,0,.20), rgba(0,0,0,0) 55%),
    radial-gradient(circle at 50% 55%, rgba(255,215,120,.98), rgba(170,120,20,.92));
  border: 2px solid rgba(255,240,190,.34);
  box-shadow:
    inset 0 0 0 2px rgba(110,70,10,.22),
    0 14px 18px rgba(0,0,0,.22),
    0 0 18px rgba(255,210,120,.18);
  display: grid;
  place-items: center;
  user-select: none;
  cursor: grab;
  touch-action: none;
  position: relative;
  letter-spacing: .3px;
}
.coin::before{
  content:"";
  position:absolute;
  inset: -3px;
  border-radius: 999px;
  background: repeating-conic-gradient(
    from 0deg,
    rgba(255,255,255,.20) 0 8deg,
    rgba(0,0,0,.14) 8deg 16deg
  );
  z-index: -1;
  filter: blur(.2px);
  opacity: .52;
}
.coin .coinFace{
  width: 52px;
  height: 52px;
  border-radius: 999px;
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(110,70,10,.26);
  box-shadow: inset 0 12px 18px rgba(255,255,255,.10), inset 0 -12px 18px rgba(0,0,0,.16);
  display:grid;
  place-items:center;
}
.coin .coinText{
  font-weight: 1000;
  font-size: 14px;
  letter-spacing: 2px;
  color: rgba(90,60,10,.92);
  text-shadow: 0 2px 0 rgba(255,255,255,.24);
}
.coin:active{ cursor: grabbing; transform: scale(.98); }
.coinGhost{
  position: fixed;
  z-index: 9999;
  pointer-events: none;
  transform: translate(-50%,-50%);
  opacity: .98;
  filter: drop-shadow(0 14px 16px rgba(0,0,0,.20));
}
.coinDrop{
  transition:
    left 200ms ease,
    top 200ms ease,
    transform 200ms ease,
    opacity 200ms ease,
    filter 200ms ease;
}

/* Big message overlay */
.bigMsg{
  position: fixed;
  inset: 0;
  z-index: 40;
  display: grid;
  place-items: center;
  background: rgba(0,0,0,.50);
  padding: 18px;
}
.bigMsg.hidden{ display: none; }
.bigMsgInner{
  text-align: center;
  padding: 18px;
  border-radius: 20px;
  background:
    radial-gradient(900px circle at 50% 0%, rgba(255,255,255,.14), transparent 60%),
    rgba(0,0,0,.26);
  border: 1px solid rgba(255,255,255,.16);
  box-shadow: var(--shadow);
  width: min(760px, 92vw);
  overflow: hidden;
  position: relative;
}
.bigTitle{
  font-family: "Protest Revolution", "Inter", system-ui;
  font-size: clamp(34px, 5.0vw, 62px);
  font-weight: 400;
  letter-spacing: .8px;
}
.bigTitle.spicy{
  font-family: "Ultra", serif;
  font-weight: 400;
  letter-spacing: 1.2px;
  background-image: linear-gradient(90deg, #ff8acb, #ffe08a, #b8ffb1, #9ad1ff, #d2a6ff, #ff8acb);
  background-size: 240% 100%;
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  animation: rainbowShift 3.2s linear infinite;
  filter: drop-shadow(0 0 14px rgba(255,255,255,.14)) drop-shadow(0 0 22px rgba(255,255,255,.08));
}
.bigSub{
  margin-top: 8px;
  color: rgba(255,255,255,.85);
  font-size: clamp(13px, 2vw, 18px);
  font-weight: 900;
  white-space: pre-line;
}
.bigTicker{
  margin: 12px auto 0;
  width: min(640px, 100%);
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  overflow: hidden;
  box-shadow: 0 12px 22px rgba(0,0,0,.18);
  display: none;
}
.bigTicker.show{ display: block; }
.bigTickerTrack{
  white-space: nowrap;
  display: inline-block;
  padding: 10px 0;
  animation: tickerRun 6.8s linear infinite;
  will-change: transform;
}
.bigTickerText{
  display: inline-block;
  font-weight: 1000;
  letter-spacing: .8px;
  color: rgba(255,255,255,.92);
  text-shadow: 0 10px 18px rgba(0,0,0,.30);
  padding: 0 22px;
}
@keyframes tickerRun{
  0%{ transform: translateX(0); }
  100%{ transform: translateX(-50%); }
}

/* END SCREEN + SHOP + FOOTER (unchanged from your last version) */
.endCard{
  width: min(820px, 92vw);
  border-radius: 26px;
  padding: 16px;
  background:
    radial-gradient(1000px circle at 50% 0%, rgba(255,255,255,.18), transparent 55%),
    radial-gradient(900px circle at 20% 40%, rgba(255,120,40,.16), transparent 55%),
    radial-gradient(900px circle at 80% 40%, rgba(255,0,200,.14), transparent 55%),
    rgba(0,0,0,.34);
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 22px 80px rgba(0,0,0,.55);
  text-align: center;
  position: relative;
  overflow: hidden;
}
.endCard::before{
  content:"";
  position:absolute; inset:-90px;
  background:
    radial-gradient(circle at 25% 30%, rgba(120,255,240,.18), transparent 55%),
    radial-gradient(circle at 75% 30%, rgba(255,110,220,.18), transparent 58%),
    radial-gradient(circle at 50% 10%, rgba(255,230,140,.16), transparent 55%);
  animation: nmGlow 6.2s ease-in-out infinite;
  pointer-events:none;
  opacity: .9;
}
.endTwinkleLayer{ position: absolute; inset: 0; pointer-events: none; z-index: 1; }
.endTwStar{
  position: absolute;
  left: var(--x);
  top: var(--y);
  width: var(--s);
  height: var(--s);
  border-radius: 999px;
  transform: translate(-50%,-50%) scale(.9);
  opacity: .12;
  background:
    radial-gradient(circle, rgba(255,255,255,.98) 0%,
                            rgba(255,244,210,.95) 10%,
                            rgba(255,220,140,.70) 24%,
                            rgba(255,200,90,.32) 42%,
                            transparent 68%),
    repeating-conic-gradient(from 0deg, rgba(255,235,180,.55) 0 1.2deg, transparent 1.2deg 9deg),
    linear-gradient(90deg, transparent 0 46%, rgba(255,230,170,.40) 50%, transparent 54%),
    linear-gradient(0deg,  transparent 0 46%, rgba(255,230,170,.40) 50%, transparent 54%);
  box-shadow: 0 0 10px rgba(255,255,255,.14), 0 0 18px rgba(255,220,140,.10);
  filter: blur(.12px);
  will-change: transform, opacity;
  animation: endTwinkle var(--t) ease-in-out infinite;
  animation-delay: var(--d);
}
@keyframes endTwinkle{
  0%,100%{ opacity:.12; transform: translate(-50%,-50%) scale(.90); filter: brightness(.98) blur(.12px); }
  50%{ opacity:.86; transform: translate(-50%,-50%) scale(1.10); filter: brightness(1.18) blur(.12px); }
}
.endTop{ position: relative; z-index: 2; display: grid; gap: 12px; justify-items: center; }
.endTitle{
  margin: 0;
  font-size: clamp(30px, 4.2vw, 56px);
  letter-spacing: .2px;
  display: inline-flex;
  gap: 6px;
  flex-wrap: wrap;
  justify-content: center;
  text-transform: none;
}
.endTitle span{ text-shadow: 0 0 14px rgba(255,255,255,.12); }
.endTitle.lucky, .endTitle.congrats{ font-family: "Molle", cursive; font-weight: 400; letter-spacing: .2px; }
.endSub{
  margin: 6px auto 0;
  color: rgba(255,255,255,.90);
  font-weight: 400;
  white-space: normal;
  line-height: 1.25;
  font-family: "Mystery Quest", cursive;
  font-size: clamp(14px, 2.0vw, 22px);
  text-shadow: 0 0 12px rgba(255,255,255,.14), 0 14px 30px rgba(0,0,0,.35);
  max-width: min(60ch, 92%);
}
.endGrid{
  width: min(740px, 100%);
  display: grid;
  gap: 12px;
  margin-top: 6px;
  justify-content: center;
  justify-items: center;
  align-items: start;
  grid-template-columns: repeat(auto-fit, minmax(210px, 230px));
}
.endToy{
  border-radius: 18px;
  padding: 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 12px 30px rgba(0,0,0,.22);
  display: grid;
  gap: 6px;
  justify-items: center;
  width: 100%;
}
.endToy .e{ font-size: 44px; filter: drop-shadow(0 14px 18px rgba(0,0,0,.30)); }
.endToy .n{ font-weight: 1000; font-size: 12px; line-height: 1.15; color: rgba(255,255,255,.92); }
.endChips{ display:flex; gap: 10px; flex-wrap: wrap; justify-content:center; }
.endBtns{ display:flex; gap: 10px; flex-wrap: wrap; justify-content:center; margin-top: 10px; }
.hiddenBtn{ display:none !important; }
.endGrid.singleCenter{ grid-template-columns: minmax(220px, 420px); justify-content: center; }

.shopStats{ display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0 12px; justify-content: center; }
.shopGrid{ display: grid; gap: 14px; grid-template-columns: repeat(4, minmax(0,1fr)); }
.shopItem{
  border-radius: 18px;
  padding: 14px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 12px 30px rgba(0,0,0,.22);
  transform: translateY(6px);
  opacity: 0;
  animation: shopIn .28s ease-out forwards;
  will-change: transform, opacity;
}
.shopItem:nth-child(2){ animation-delay: .04s; }
.shopItem:nth-child(3){ animation-delay: .08s; }
.shopItem:nth-child(4){ animation-delay: .12s; }
.shopItem:nth-child(5){ animation-delay: .16s; }
.shopItem:nth-child(6){ animation-delay: .20s; }
.shopItem:nth-child(7){ animation-delay: .24s; }
.shopItem:nth-child(8){ animation-delay: .28s; }
@keyframes shopIn{ to{ transform: translateY(0); opacity: 1; } }
.shopName{ font-weight: 1000; margin: 0 0 8px 0; font-size: 16px; display: flex; align-items: center; gap: 10px; }
.shopEmoji{ font-size: 42px; line-height: 1; }
.shopDesc{ margin: 0 0 10px 0; color: rgba(255,255,255,.80); font-size: 13px; line-height: 1.35; }
.shopBuyRow{ display: flex; justify-content: space-between; align-items: center; gap: 10px; }
.shopCost{ font-weight: 1000; font-size: 13px; }
.shopFooter{ margin-top: 12px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

.footer{
  opacity: .9;
  font-size: 12px;
  font-weight: 700;
  padding: 10px 0 6px;
  display: grid;
  grid-template-columns:
    clamp(240px, 22vw, 330px)
    1fr
    clamp(240px, 22vw, 330px);
  align-items: center;
}
.footer span{
  grid-column: 1;
  justify-self: start;
  padding-left: 10px;
}
  </style>
</head>

<body>
  <div id="stars" aria-hidden="true"></div>
  <div id="balloons" aria-hidden="true"></div>

  <canvas id="confetti" aria-hidden="true"></canvas>
  <div id="fxLayer" aria-hidden="true"></div>

  <!-- WELCOME MODAL -->
  <div id="welcomeModal" class="modal show" role="dialog" aria-modal="true">
    <div class="modalCard">

      <!-- PAGE 1 -->
      <div id="welcomePage">
        <div class="welcomeWrap">
          <div class="nmHero">
            <div class="twinkleLayer" id="twinkles" aria-hidden="true"></div>
            <div class="sparkles" id="sparkles" aria-hidden="true"></div>

            <div class="flagRow" aria-hidden="true">
              <div class="flagString"></div>
              <div class="flagsWrap">
                <div class="flagsLine" id="flagsTop"></div>
                <div class="flagsLine" id="flagsBottom"></div>
              </div>
              <div class="flagString"></div>
            </div>

            <div class="neonSign">
              <div class="neonKicker">NIGHT MARKET GAME</div>

              <h2 class="neonTitle">
                <span class="rainbowCongrats">Color Memory Wheel</span>
              </h2>

              <p class="neonSub">Spin â€¢ Remember â€¢ Win Tickets</p>

              <div class="nmIcons" aria-hidden="true">
                <div class="nmChip">ðŸ§¸ Prizes</div>
                <div class="nmChip">ðŸŽˆ Bonus</div>
                <div class="nmChip">ðŸŽ¡ Spin</div>
              </div>
            </div>
          </div>

          <div class="welcomeCTA">
            <button id="welcomeNextBtn" class="btn primary glowBtn" type="button">Enter</button>
          </div>
        </div>
      </div>

      <!-- PAGE 2 -->
      <div id="instructionsPage" class="hiddenPage">
        <h2 class="modalTitle oneLine">How to Play</h2>
        <p class="modalSub oneLine">Color Memory Wheel</p>

        <div class="modalSection" style="background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 16px; padding: 12px; margin-bottom: 14px;">
          <h3 class="modalH" style="text-align:center; margin:0 0 8px 0; font-size:13px; color:rgba(255,255,255,.9); font-weight:900;">Instructions</h3>
          <ol class="modalList" style="margin:0; padding-left:18px; color:rgba(255,255,255,.82); line-height:1.45; font-weight:600;">
            <li>Drag the <b>coin</b> into the coin slot.</li>
            <li>Press <b>Start Game</b>.</li>
            <li>Watch the wheel flash the pattern (each color has its own sound).</li>
            <li>Tap the colors in the same order.</li>
            <li>Earn <b>+1 ticket</b> after every successful round.</li>
            <li><b>Bonus each round:</b> a <b>ticket</b> gives <b>+1 ticket</b>, or a <b>balloon</b> gives <b>+seconds</b>.</li>
          </ol>
        </div>

        <div class="coinArea">
          <div class="coinHint">Insert Coin (drag into the slot)</div>
          <div class="coinRow">
            <div id="coinSlot" class="coinSlot" aria-hidden="true">
              <div class="coinMouth" aria-hidden="true"></div>
              <div id="coinSlotState" class="coinSlotState">NO COIN</div>
              <div class="coinSlotLabel">COIN SLOT</div>
            </div>
            <div class="coinPad">
              <div id="coin" class="coin" role="button" aria-label="Coin">
                <div class="coinFace">
                  <div class="coinText">COIN</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <button id="startBtn" class="btn primary bigBtn glowBtn" type="button" disabled>Start Game</button>

        <div class="modalNav">
          <button id="welcomeBackBtn" class="btn" type="button">Back</button>
        </div>
      </div>

    </div>
  </div>

  <!-- BIG MESSAGE OVERLAY -->
  <div id="bigMsg" class="bigMsg hidden" aria-hidden="true">
    <div class="bigMsgInner">
      <div id="bigTitle" class="bigTitle">...</div>
      <div id="bigSub" class="bigSub">...</div>

      <div id="bigTicker" class="bigTicker" aria-hidden="true">
        <div id="bigTickerTrack" class="bigTickerTrack">
          <span id="bigTickerTextA" class="bigTickerText">...</span>
          <span id="bigTickerTextB" class="bigTickerText">...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- END SCREEN -->
  <div id="endCongratsModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="endCard">
      <div class="endTwinkleLayer" id="endTwinkles" aria-hidden="true"></div>

      <div class="endTop">
        <h2 id="endTitle" class="endTitle"></h2>

        <p id="endSub" class="endSub">You collected prizes!</p>

        <div class="endChips">
          <div class="shopChip"><span class="k">Tickets left:</span> <span id="endTickets">0</span></div>
          <div class="shopChip"><span class="k">Prizes:</span> <span id="endPrizeCount">0</span></div>
          <div class="shopChip"><span class="k">Best:</span> <span id="endBest">0</span></div>
        </div>

        <div id="endToysGrid" class="endGrid"></div>

        <div class="endBtns">
          <button id="endPlayAgainBtn" class="btn primary glowBtn hiddenBtn" type="button">Try again for a prize!</button>
          <button id="endBackToWelcomeBtn" class="btn primary glowBtn" type="button">End Game</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PRIZE SHOP MODAL -->
  <div id="shopModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modalCard wide">
      <h2 class="modalTitle">Prize Shop</h2>
      <p class="modalSub oneLine">Spend tickets on toys â€” or continue playing.</p>

      <div class="shopStats">
        <div class="shopChip"><span class="k">Tickets:</span> <span id="shopTickets">0</span></div>
        <div class="shopChip"><span class="k">Toy Prizes:</span> <span id="prizeCount">0</span></div>
        <div class="shopChip"><span class="k">Best:</span> <span id="shopBest">0</span></div>
      </div>

      <div id="shopItems" class="shopGrid"></div>

      <div class="shopFooter">
        <button id="shopContinueBtn" class="btn primary" type="button">Continue Game</button>
        <button id="backToHomeBtn" class="btn" type="button">End</button>
      </div>
    </div>
  </div>

  <!-- SCALE ROOT -->
  <div id="scaleRoot">
    <main class="app">
      <section class="stage">
        <aside class="leftPanel">
          <div class="panelTitle">Game Details</div>
          <div class="leftPanelInner">
            <div class="hudGrid">
              <div class="stat">
                <div class="statLabel">Round</div>
                <div class="statValue" id="roundEl">0</div>
              </div>
              <div class="stat">
                <div class="statLabel">Tickets</div>
                <div class="statValue" id="ticketsEl">0</div>
              </div>
              <div class="stat">
                <div class="statLabel">Prizes</div>
                <div class="statValue" id="prizesEl">0</div>
              </div>
              <div class="stat">
                <div class="statLabel">Best</div>
                <div class="statValue" id="bestEl">0</div>
              </div>
            </div>



            <div class="panel">
              <div class="status" id="statusEl">Insert coin on the welcome page to start.</div>

              <div class="bonusWrap">
                <div class="bonusLabel">Bonus (each round)</div>
                <div id="bonusBalloons" class="bonusBalloons"></div>
              </div>

              <div class="rows">
                <div class="row">
                  <div class="rowLabel">Pattern length</div>
                  <div class="pips" id="patternSlots"></div>
                </div>

                <div class="row">
                  <div class="rowLabel">Your input</div>
                  <div class="pips" id="playerPips"></div>
                </div>
              </div>

              <div class="hint">Tip: Memorize the sequence as numbers (1â€“10), then tap in the same order.</div>

              <div class="musicCenterControls" style="display:flex; gap:12px; align-items:center; justify-content:center; margin-top:10px;">
                <button id="musicToggleSideBtn" class="musicToggleBtn" type="button">Music: On</button>
                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="musicVolume" class="musicVolume" type="range" min="0" max="1" step="0.01" value="1" aria-label="Music volume" />
                  <div id="musicVolLabel" class="musicVolLabel" style="min-width:48px; text-align:right; cursor:pointer;">100%</div>
                </div>
              </div>
            </div>
          </div>
        </aside>

        <section class="centerCol">
          <div class="centerHeader">
            <div class="centerTitle">
              <span class="rainbowCongrats">Color Memory Wheel</span>
            </div>
            <div class="centerSubtitle oneLine">Spin â€¢ Watch â€¢ Remember</div>


          </div>

          <div class="wheelWrap">
            <div class="pointer" aria-hidden="true"></div>
            <div id="wheelLights" class="wheelLights" aria-hidden="true"></div>

            <div id="rotator" class="rotator">
              <svg id="wheelSvg" viewBox="0 0 300 300" role="img" aria-label="Color memory wheel"></svg>
            </div>

            <div class="centerOverlay" aria-hidden="true">
              <div class="centerGlass">
                <svg class="hg" viewBox="0 0 100 100">
                  <defs>
                    <clipPath id="topClip"><rect id="topRect" x="25" y="10" width="50" height="40"></rect></clipPath>
                    <clipPath id="bottomClip"><rect id="bottomRect" x="25" y="90" width="50" height="0"></rect></clipPath>
                  </defs>
                  <polygon class="hgSand" points="25,10 75,10 60,50 40,50" clip-path="url(#topClip)"></polygon>
                  <polygon class="hgSand" points="40,50 60,50 75,90 25,90" clip-path="url(#bottomClip)"></polygon>
                  <polygon class="hgGlass" points="25,10 75,10 60,50 75,90 25,90 40,50"></polygon>
                  <line class="hgNeck" x1="50" y1="48" x2="50" y2="52"></line>
                </svg>
                <div class="timerText" id="timerText">--</div>
              </div>
            </div>
          </div>
        </section>

        <aside class="rightPanel">
          <div class="panelTitle">Prize Toys</div>
          <div class="rightPanelInner">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;">
              <div class="shopChip"><span class="k">Owned:</span> <span id="ownedCount">0</span></div>
              <div class="shopChip"><span class="k">Tickets:</span> <span id="ticketsChip">0</span></div>
            </div>

            <div id="allToysGrid" class="allToysGrid"></div>
          </div>
        </aside>
      </section>

      <footer class="footer">
        <span>Created by Mirene Jane Grejalde (è²´æ•å¸Œ)</span>
      </footer>
    </main>
  </div>

  <script>
const SLICE_COLORS = [
  "#FF3B3B","#FF8C00","#FFD400","#A7F432","#00C853",
  "#00E5FF","#00A3FF","#3F51B5","#8A2BE2","#FF4FD8"
];

let SHOP_ITEMS = [
  { id:"ball",   emoji:"âš½", name:"Mini Bouncy Ball",       cost:2,  desc:"Small, bouncy, and impossible to not toss." },
  { id:"bt",     emoji:"ðŸ§‹", name:"Bubble Tea Keyring",     cost:4,  desc:"A boba keyring that screams night market." },
  { id:"duck",   emoji:"ðŸ¦†", name:"Rubber Duck",            cost:4,  desc:"Classic squeaky duck for pure joy." },
  { id:"yoyo",   emoji:"ðŸª€", name:"Classic Yo-Yo",          cost:6,  desc:"Smooth spin yo-yo for simple tricks." },
  { id:"car",    emoji:"ðŸš—", name:"Wind-Up Toy Car",        cost:6,  desc:"Wind it up and it zooms across the table." },
  { id:"cube",   emoji:"ðŸ§©", name:"Mini Puzzle Cube",       cost:8,  desc:"A tiny cube puzzle to keep your hands busy." },
  { id:"squish", emoji:"ðŸ™", name:"Squishy Octopus",        cost:8,  desc:"Soft squishy toyâ€”super popular at night markets." },
  { id:"teddy",  emoji:"ðŸ§¸", name:"Plush Teddy Bear",       cost:10, desc:"Big soft plush prize â€” top shelf reward!" },
];
function sortShopItems(){ SHOP_ITEMS = [...SHOP_ITEMS].sort((a,b) => a.cost - b.cost || a.name.localeCompare(b.name)); }
sortShopItems();

const els = {
  stars: document.getElementById("stars"),
  balloons: document.getElementById("balloons"),
  confetti: document.getElementById("confetti"),
  fxLayer: document.getElementById("fxLayer"),
  scaleRoot: document.getElementById("scaleRoot"),

  twinkles: document.getElementById("twinkles"),
  sparkles: document.getElementById("sparkles"),
  flagsTop: document.getElementById("flagsTop"),
  flagsBottom: document.getElementById("flagsBottom"),

  welcomeModal: document.getElementById("welcomeModal"),
  welcomePage: document.getElementById("welcomePage"),
  instructionsPage: document.getElementById("instructionsPage"),
  welcomeNextBtn: document.getElementById("welcomeNextBtn"),
  welcomeBackBtn: document.getElementById("welcomeBackBtn"),

  startBtn: document.getElementById("startBtn"),
  coin: document.getElementById("coin"),
  coinSlot: document.getElementById("coinSlot"),
  coinSlotState: document.getElementById("coinSlotState"),

  bigMsg: document.getElementById("bigMsg"),
  bigTitle: document.getElementById("bigTitle"),
  bigSub: document.getElementById("bigSub"),
  bigTicker: document.getElementById("bigTicker"),
  bigTickerTextA: document.getElementById("bigTickerTextA"),
  bigTickerTextB: document.getElementById("bigTickerTextB"),
  bigTickerTrack: document.getElementById("bigTickerTrack"),

  endCongratsModal: document.getElementById("endCongratsModal"),
  endTitle: document.getElementById("endTitle"),
  endSub: document.getElementById("endSub"),
  endTickets: document.getElementById("endTickets"),
  endPrizeCount: document.getElementById("endPrizeCount"),
  endBest: document.getElementById("endBest"),
  endToysGrid: document.getElementById("endToysGrid"),
  endTwinkles: document.getElementById("endTwinkles"),
  endBackToWelcomeBtn: document.getElementById("endBackToWelcomeBtn"),
  endPlayAgainBtn: document.getElementById("endPlayAgainBtn"),

  shopModal: document.getElementById("shopModal"),
  shopItems: document.getElementById("shopItems"),
  shopTickets: document.getElementById("shopTickets"),
  prizeCount: document.getElementById("prizeCount"),
  shopBest: document.getElementById("shopBest"),
  backToHomeBtn: document.getElementById("backToHomeBtn"),
  shopContinueBtn: document.getElementById("shopContinueBtn"),

  roundEl: document.getElementById("roundEl"),
  bestEl: document.getElementById("bestEl"),
  ticketsEl: document.getElementById("ticketsEl"),
  ticketsChip: document.getElementById("ticketsChip"),
  prizesEl: document.getElementById("prizesEl"),

  ownedCount: document.getElementById("ownedCount"),
  allToysGrid: document.getElementById("allToysGrid"),

  statusEl: document.getElementById("statusEl"),
  patternSlots: document.getElementById("patternSlots"),
  playerPips: document.getElementById("playerPips"),
  bonusBalloons: document.getElementById("bonusBalloons"),

  wheelSvg: document.getElementById("wheelSvg"),
  rotator: document.getElementById("rotator"),
  wheelLights: document.getElementById("wheelLights"),

  timerText: document.getElementById("timerText"),
  topRect: document.getElementById("topRect"),
  bottomRect: document.getElementById("bottomRect"),
};

let best = Number(localStorage.getItem("mcw_best_carnival") || "0");
let prizesOwned = JSON.parse(localStorage.getItem("mcw_prizes_owned_carnival") || "[]");

function dedupePrizesOwned(){
  prizesOwned = Array.from(new Set(prizesOwned)).filter(Boolean);
  localStorage.setItem("mcw_prizes_owned_carnival", JSON.stringify(prizesOwned));
}
dedupePrizesOwned();

let segments = [];
let rotationDeg = 0;
let gameActive = false;
let busy = false;
let isPlayerTurn = false;

let round = 0;
let tickets = 0;

let sequence = [];
let expected = [];
let player = [];

let rafId = null;
let timerStart = 0;
let timerTotal = 0;
let pendingTimeBonusMs = 0;
let lastTimerText = "";

let audioCtx = null;
let master = null;

let coinInserted = false;
let balloonInterval = null;

function wait(ms){ return new Promise(r => setTimeout(r, ms)); }
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function shuffle(arr){
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function setStatus(msg){ els.statusEl.textContent = msg; }

/* Stars */
function buildStars(){
  els.stars.innerHTML = "";
  const n = 54;
  for (let i=0;i<n;i++){
    const s = document.createElement("div");
    s.className = "star";
    const size = (8 + Math.random()*12).toFixed(2);
    s.style.setProperty("--x", `${(Math.random()*100).toFixed(2)}%`);
    s.style.setProperty("--y", `${(Math.random()*100).toFixed(2)}%`);
    s.style.setProperty("--s", `${size}px`);
    s.style.setProperty("--t", `${(2.4 + Math.random()*3.8).toFixed(2)}s`);
    s.style.setProperty("--d", `${(-Math.random()*3.5).toFixed(2)}s`);
    els.stars.appendChild(s);
  }
}

/* End twinkles */
function buildEndTwinkles(){
  els.endTwinkles.innerHTML = "";
  const n = 32;
  for (let i=0;i<n;i++){
    const s = document.createElement("div");
    s.className = "endTwStar";
    const size = (8 + Math.random()*12).toFixed(2);
    s.style.setProperty("--x", `${(Math.random()*100).toFixed(2)}%`);
    s.style.setProperty("--y", `${(Math.random()*100).toFixed(2)}%`);
    s.style.setProperty("--s", `${size}px`);
    s.style.setProperty("--t", `${(1.9 + Math.random()*2.6).toFixed(2)}s`);
    s.style.setProperty("--d", `${(-Math.random()*2.6).toFixed(2)}s`);
    els.endTwinkles.appendChild(s);
  }
}

/* Flags */
function buildFlags(){
  els.flagsTop.innerHTML = "";
  els.flagsBottom.innerHTML = "";
  const perRow = 16;
  const total = perRow * 2;
  for (let i=0;i<total;i++){
    const f = document.createElement("div");
    f.className = "flag";
    f.style.setProperty("--h", String(Math.floor(Math.random()*360)));
    f.style.setProperty("--d", `${(-Math.random()*1.7).toFixed(2)}s`);
    (i < perRow ? els.flagsTop : els.flagsBottom).appendChild(f);
  }
}

/* Welcome sparkles */
function buildSparkles(){
  els.sparkles.innerHTML = "";
  const n = 16;
  for (let i=0;i<n;i++){
    const s = document.createElement("div");
    s.className = "sparkle";
    s.style.setProperty("--x", `${(Math.random()*100).toFixed(2)}%`);
    s.style.setProperty("--y", `${(Math.random()*100).toFixed(2)}%`);
    s.style.setProperty("--s", `${(8 + Math.random()*10).toFixed(2)}px`);
    s.style.setProperty("--t", `${(2.1 + Math.random()*2.4).toFixed(2)}s`);
    s.style.setProperty("--d", `${(-Math.random()*2.5).toFixed(2)}s`);
    els.sparkles.appendChild(s);
  }
}
function buildTwinkles(){
  els.twinkles.innerHTML = "";
  const n = 30;
  for (let i=0;i<n;i++){
    const d = document.createElement("div");
    d.className = "twStar";
    d.style.setProperty("--x", `${(Math.random()*100).toFixed(2)}%`);
    d.style.setProperty("--y", `${(Math.random()*100).toFixed(2)}%`);
    d.style.setProperty("--s", `${(8 + Math.random()*12).toFixed(2)}px`);
    d.style.setProperty("--t", `${(1.9 + Math.random()*2.2).toFixed(2)}s`);
    d.style.setProperty("--d", `${(-Math.random()*2.6).toFixed(2)}s`);
    els.twinkles.appendChild(d);
  }
}

/* Auto-scale */
function applyAppScale(){
  document.documentElement.style.setProperty("--appScale", "1");
  const rect = els.scaleRoot.getBoundingClientRect();
  const pad = 18;
  const vw = window.innerWidth - pad * 2;
  const vh = window.innerHeight - pad * 2;
  const sx = vw / rect.width;
  const sy = vh / rect.height;
  const s = Math.min(1, sx, sy);
  document.documentElement.style.setProperty("--appScale", String(s));
  resizeConfettiCanvas();
}
window.addEventListener("resize", () => {
  applyAppScale();
  renderAllToys();
  renderShopItems();
  buildStars();
  buildEndTwinkles();
  buildTwinkles();
  buildSparkles();
});

/* extra scale passes after fonts load */
window.addEventListener("load", () => {
  setTimeout(applyAppScale, 600);
  setTimeout(applyAppScale, 1500);
});

/* Welcome pages */
function showWelcome(){
  els.welcomeModal.classList.add("show");
  els.welcomeModal.classList.remove("hidden");
  showWelcomePage();
  setStatus("Welcome! Enter to see instructions and insert coin.");
  confettiBurst(window.innerWidth * 0.5, window.innerHeight * 0.35, 80, 4.0);
}
function hideWelcome(){
  els.welcomeModal.classList.remove("show");
  els.welcomeModal.classList.add("hidden");
}
function showWelcomePage(){
  els.welcomePage.classList.remove("hiddenPage");
  els.instructionsPage.classList.add("hiddenPage");
}
function showInstructionsPage(){
  els.welcomePage.classList.add("hiddenPage");
  els.instructionsPage.classList.remove("hiddenPage");
}

/* Big message overlay */
async function showBigMessage({title, sub = "", ms = 900, tickerText = "", spicy = false}){
  els.bigTitle.textContent = title;
  els.bigSub.textContent = sub;

  els.bigTitle.classList.toggle("spicy", !!spicy);

  if (tickerText){
    els.bigTickerTextA.textContent = tickerText;
    els.bigTickerTextB.textContent = tickerText;
    els.bigTicker.classList.add("show");
    els.bigTickerTrack.style.animation = "none";
    void els.bigTickerTrack.offsetHeight;
    els.bigTickerTrack.style.animation = "";
  } else {
    els.bigTicker.classList.remove("show");
  }

  els.bigMsg.classList.remove("hidden");
  await wait(ms);
  els.bigMsg.classList.add("hidden");
  els.bigTicker.classList.remove("show");
}

/* =========================
   BALLOONS (LESS + SIZES)
   ========================= */
function randomBalloonSize(){
  // Mostly small/medium, occasional large (no more "too many big balloons")
  const r = Math.random();
  if (r < 0.55) return 40 + Math.random() * 34;   // 40â€“74 small
  if (r < 0.92) return 74 + Math.random() * 44;   // 74â€“118 medium
  return 118 + Math.random() * 34;                // 118â€“152 large (rare)
}
function spawnOneBalloon({xPct=null, durationS=null, sizePx=null} = {}){
  const b = document.createElement("div");
  b.className = "balloon";
  const x = xPct ?? (Math.random() * 100);

  const w = sizePx ?? randomBalloonSize();
  const t = durationS ?? (12 + Math.random() * 14);

  b.style.setProperty("--x", `${x}%`);
  b.style.setProperty("--w", `${w.toFixed(1)}px`);
  b.style.setProperty("--h", `${Math.floor(Math.random() * 360)}`);
  b.style.setProperty("--t", `${t.toFixed(2)}s`);
  b.style.setProperty("--s", `${(50 + Math.random() * 120).toFixed(0)}px`);

  const string = document.createElement("div");
  string.className = "string";
  b.appendChild(string);

  els.balloons.appendChild(b);
  setTimeout(() => { if (b.isConnected) b.remove(); }, (t * 1000) + 1200);
}
function spawnBackgroundBalloons(){
  // âœ… more balloons at start
  for (let i = 0; i < 14; i++){
    spawnOneBalloon({ durationS: 10 + Math.random() * 12 });
  }
  if (balloonInterval) clearInterval(balloonInterval);

  // âœ… faster spawn rate + more frequent multiple spawns
  balloonInterval = setInterval(() => {
    spawnOneBalloon();
    if (Math.random() < 0.25) spawnOneBalloon();
    // occasional triple burst
    if (Math.random() < 0.08) spawnOneBalloon();
  }, 1600);
}

/* Wheel lights */
function buildWheelLights(){
  els.wheelLights.innerHTML = "";
  const n = 34;
  for (let i = 0; i < n; i++){
    const a = (Math.PI * 2) * (i / n);
    const x = 50 + Math.cos(a) * 48;
    const y = 50 + Math.sin(a) * 48;
    const b = document.createElement("div");
    b.className = "wheelBulb";
    b.style.left = `${x}%`;
    b.style.top = `${y}%`;
    b.style.setProperty("--d", `${(-Math.random()*2.4).toFixed(2)}s`);
    els.wheelLights.appendChild(b);
  }
}

/* Wheel */
function buildSegments(){
  const palette = shuffle(SLICE_COLORS);
  segments = palette.map(c => ({ color: c }));
}
function polarToXY(cx, cy, r, angleDeg){
  const rad = (angleDeg * Math.PI) / 180;
  return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
}
function wedgePath(cx, cy, r, startDeg, endDeg){
  const a0 = polarToXY(cx, cy, r, startDeg);
  const a1 = polarToXY(cx, cy, r, endDeg);
  const largeArc = (endDeg - startDeg) > 180 ? 1 : 0;
  return `M ${cx} ${cy} L ${a0.x} ${a0.y} A ${r} ${r} 0 ${largeArc} 1 ${a1.x} ${a1.y} Z`;
}
function renderWheel(){
  els.wheelSvg.innerHTML = "";
  const cx = 150, cy = 150, r = 140;
  const n = segments.length;
  const slice = 360 / n;

  const ring = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  ring.setAttribute("cx", cx);
  ring.setAttribute("cy", cy);
  ring.setAttribute("r", r - 1);
  ring.setAttribute("fill", "none");
  ring.setAttribute("stroke", "rgba(255,255,255,.18)");
  ring.setAttribute("stroke-width", "6");
  els.wheelSvg.appendChild(ring);

  for (let i = 0; i < n; i++){
    const seg = segments[i];
    const start = i * slice - 90;
    const end = (i + 1) * slice - 90;

    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", wedgePath(cx, cy, r, start, end));
    path.setAttribute("fill", seg.color);
    path.classList.add("slice");
    path.dataset.slice = String(i);
    path.style.setProperty("--glow", seg.color);
    els.wheelSvg.appendChild(path);
  }
}
function setSlicesDim(dim){
  els.wheelSvg.classList.toggle("dimAll", !!dim);
}

/* Sounds */
const COLOR_TONES = [262, 294, 330, 349, 392, 440, 494, 523, 587, 659];
const COLOR_WAVES = ["sine","triangle","sine","triangle","sine","triangle","sine","triangle","sine","triangle"];
function sfxColor(index, kind="tap"){
  if (!audioCtx || !master) return;
  const i = clamp(index|0, 0, 9);
  const t = audioCtx.currentTime;
  const base = COLOR_TONES[i];
  const type = COLOR_WAVES[i];
  const g = (kind === "flash") ? 0.06 : 0.10;
  const dur = (kind === "flash") ? 0.07 : 0.10;
  tone(base, t, dur, type, g);
  tone(base * 2, t + 0.015, dur * 0.7, "sine", g * 0.55);
}

/* Instant flash */
function flashSliceNow(sliceIndex, ms){
  const node = els.wheelSvg.querySelector(`.slice[data-slice="${sliceIndex}"]`);
  if (!node) return;
  const glow = segments[sliceIndex]?.color || "#fff";

  if (node._flashTO) clearTimeout(node._flashTO);

  node.classList.add("activeFlash");
  node.style.stroke = "rgba(255,255,255,1)";
  node.style.strokeWidth = "12";
  node.style.filter = `drop-shadow(0 0 14px ${glow}) drop-shadow(0 0 22px ${glow})`;

  node._flashTO = setTimeout(() => {
    node.style.stroke = "";
    node.style.strokeWidth = "";
    node.style.filter = "";
    node.classList.remove("activeFlash");
    node._flashTO = null;
  }, ms);
}
async function flashSliceAsync(sliceIndex, ms){
  flashSliceNow(sliceIndex, ms);
  sfxColor(sliceIndex, "flash");
  await wait(ms);
}

/* Spin */
function spinOnce(durationMs){
  return new Promise((resolve) => {
    rotationDeg += 1800 + Math.random() * 2400;
    els.rotator.style.transition = `transform ${durationMs}ms cubic-bezier(.18,.88,.1,1)`;
    els.rotator.style.transform = `rotate(${rotationDeg}deg) translateZ(0)`;
    const onEnd = (ev) => {
      if (ev.propertyName !== "transform") return;
      els.rotator.removeEventListener("transitionend", onEnd);
      resolve();
    };
    els.rotator.addEventListener("transitionend", onEnd);
  });
}

/* Hourglass */
function setHourglass(fraction){
  const clamped = Math.max(0, Math.min(1, fraction));
  const topH = 40 * clamped;
  const bottomH = 40 * (1 - clamped);
  els.topRect.setAttribute("height", topH.toFixed(2));
  const bottomY = 90 - bottomH;
  els.bottomRect.setAttribute("y", bottomY.toFixed(2));
  els.bottomRect.setAttribute("height", bottomH.toFixed(2));
}
function stopTimer(){
  if (rafId){ cancelAnimationFrame(rafId); rafId = null; }
  els.timerText.textContent = "--";
  lastTimerText = "";
  setHourglass(1);
}
function addTimeBonus(ms){
  if (rafId){
    timerTotal = Math.min(45000, timerTotal + ms);
  } else {
    pendingTimeBonusMs = Math.min(45000, pendingTimeBonusMs + ms);
  }
}
function startTimer(){
  stopTimer();
  const base = 2400;
  const perPick = 980;
  timerTotal = Math.min(32000, base + (expected.length * perPick) + pendingTimeBonusMs);
  pendingTimeBonusMs = 0;

  timerStart = performance.now();
  const tick = (now) => {
    const elapsed = now - timerStart;
    const remaining = Math.max(0, timerTotal - elapsed);
    const frac = remaining / timerTotal;
    setHourglass(frac);

    const txt = `${(remaining / 1000).toFixed(1)}s`;
    if (txt !== lastTimerText){
      els.timerText.textContent = txt;
      lastTimerText = txt;
    }

    if (remaining <= 0){ loseGame("TIME UP"); return; }
    rafId = requestAnimationFrame(tick);
  };
  rafId = requestAnimationFrame(tick);
}

/* Pips */
function renderSlots(len){
  els.patternSlots.innerHTML = "";
  for (let i = 0; i < len; i++){
    const d = document.createElement("div");
    d.className = "pip slot";
    els.patternSlots.appendChild(d);
  }
}
function renderPlayerPips(){
  els.playerPips.innerHTML = "";
  for (const s of player){
    const d = document.createElement("div");
    d.className = "pip";
    d.style.background = segments[s].color;
    els.playerPips.appendChild(d);
  }
}

/* Bonus */
function clearBonusBalloons(){ els.bonusBalloons.innerHTML = ""; }
function spawnTicketBonus(){
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "bonusBtn bonusTicket";
  btn.innerHTML = `<div class="ticketInner"><span class="ticketIcon">ðŸŽŸï¸</span><span>+1 TICKET</span></div>`;
  btn.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    ensureAudio();
    if (!gameActive) return;
    tickets += 1;
    updateHUD();
    setStatus("Bonus ticket! +1 ticket ðŸŽŸï¸");
    sfxBell();
    const r = btn.getBoundingClientRect();
    confettiBurst(r.left + r.width/2, r.top + r.height/2, 60, 3.4);
    btn.classList.add("pop");
    setTimeout(() => btn.remove(), 160);
  });
  return btn;
}
function spawnSecondsBalloon(){
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "bonusBtn bonusBalloonCircle";
  btn.style.setProperty("--h", `${Math.floor(Math.random() * 360)}`);
  const bonusMs = 2500;
  btn.innerHTML = `
    <div>
      <div class="big">+2.5s</div>
      <div class="small">TIME</div>
    </div>
    <div class="string" aria-hidden="true"></div>
  `;
  btn.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    ensureAudio();
    if (!gameActive) return;
    addTimeBonus(bonusMs);
    setStatus("Bonus time! +2.5 seconds â±ï¸");
    sfxBell();
    const r = btn.getBoundingClientRect();
    confettiBurst(r.left + r.width/2, r.top + r.height/2, 60, 3.4);
    btn.classList.add("pop");
    setTimeout(() => btn.remove(), 160);
  });
  return btn;
}
function spawnRoundBonus(){
  clearBonusBalloons();
  if (!gameActive) return;
  const node = (Math.random() < 0.5) ? spawnTicketBonus() : spawnSecondsBalloon();
  els.bonusBalloons.appendChild(node);
  setTimeout(() => {
    if (!node.isConnected) return;
    node.classList.add("pop");
    setTimeout(() => node.remove(), 200);
  }, 5000);
}

/* Pattern */
function randomColorIndex(){
  let idx = Math.floor(Math.random() * 10);
  if (sequence.length){
    const last = sequence[sequence.length - 1];
    if (idx === last && Math.random() < 0.75){
      idx = (idx + 1 + Math.floor(Math.random() * 9)) % 10;
    }
  }
  return idx;
}

/* Round 5: little faster */
function getFlashTiming(){
  let flashMs = 560 - (round * 12);
  let gapMs   = 150 - (round * 3);

  if (round >= 5){
    flashMs -= 40;
    gapMs   -= 10;
  }

  flashMs = clamp(Math.floor(flashMs), 290, 560);
  gapMs   = clamp(Math.floor(gapMs),   80, 150);

  return { flashMs, gapMs };
}

async function showSequence(){
  setSlicesDim(true);
  sfxBell();
  const { flashMs, gapMs } = getFlashTiming();
  for (const s of sequence){
    await wait(gapMs);
    await flashSliceAsync(s, flashMs);
  }
  setSlicesDim(false);
}
async function playRound(){
  busy = true;
  isPlayerTurn = false;
  player = [];
  renderPlayerPips();
  renderSlots(sequence.length);
  expected = [...sequence];

  setStatus(`Round ${round}: spinning...`);
  await spinOnce(Math.min(6500, 3300 + round * 180));

  setStatus("Watch the pattern.");
  await showSequence();

  setStatus("Spinning again...");
  await spinOnce(2100);

  setStatus("Your turn: repeat the colors.");
  isPlayerTurn = true;
  busy = false;
  startTimer();
}

async function advanceRound(){
  round += 1;
  sequence.push(randomColorIndex());
  updateHUD();
  spawnRoundBonus();

  if (round >= 2){
    // small cue before announcing round
    ensureAudio(); sfxRoundAdvance();

    const emojiRun = `ðŸ®ðŸŽâœ¨ ðŸ¢ðŸ§‹ðŸ¡ ðŸŽŸï¸ðŸŽ¡ðŸ§¸ âœ¨ðŸŽðŸ® ðŸ¡ðŸ§‹ðŸ¢ ðŸ§¸ðŸŽ¡ðŸŽŸï¸ `;
    await showBigMessage({
      title: `ROUND ${round}`,
      sub: "Proceeding...",
      ms: 1700,
      tickerText: emojiRun + emojiRun + emojiRun,
      spicy: true
    });
  }
  await playRound();
}

/* Lose + Shop */
async function loseGame(reason){
  stopTimer();
  isPlayerTurn = false;
  busy = false;
  clearBonusBalloons();
  pendingTimeBonusMs = 0;

  const score = Math.max(0, round - 1);
  const newBest = score > best;
  best = Math.max(best, score);
  localStorage.setItem("mcw_best_carnival", String(best));

  gameActive = false;
  updateHUD();

  // sound and music stop for game over
  ensureAudio(); sfxGameOver();
  stopBackgroundMusic();
  await showBigMessage({
    title: "GAME OVER!",
    sub: `Reason: ${reason}`,
    ms: 950,
    tickerText: "",
    spicy: true
  });

  if (newBest){
    confettiBurst(window.innerWidth * 0.5, window.innerHeight * 0.35, 160, 4.4);
  }
  openShop();
}

/* Player input */
function onPlayerPick(colorIndex){
  if (!gameActive || !isPlayerTurn || busy) return;
  ensureAudio();
  sfxColor(colorIndex, "tap");
  flashSliceNow(colorIndex, 140);

  player.push(colorIndex);
  renderPlayerPips();

  const idx = player.length - 1;
  if (player[idx] !== expected[idx]){
    loseGame("WRONG COLOR");
    return;
  }
  if (player.length === expected.length){
    stopTimer();
    isPlayerTurn = false;

    tickets += 1;
    sfxCheer();

    clearBonusBalloons();
    setStatus("Correct! +1 ticket. Next round...");
    updateHUD();

    const w = els.wheelSvg.getBoundingClientRect();
    confettiBurst(w.left + w.width/2, w.top + w.height/2, 110, 4.0);

    busy = true;
    setTimeout(() => { busy = false; advanceRound(); }, 620);
  }
}

/* Start new run */
async function startNewGame({ resetTickets }){
  if (gameActive || busy) return;
  ensureAudio();
  sfxCoin();
  startBackgroundMusic();

  buildSegments();
  renderWheel();

  rotationDeg = 0;
  els.rotator.style.transform = `rotate(${rotationDeg}deg) translateZ(0)`;

  round = 0;
  sequence = [];
  expected = [];
  player = [];

  pendingTimeBonusMs = 0;
  if (resetTickets) tickets = 0;

  gameActive = true;
  clearBonusBalloons();

  stopTimer();
  updateHUD();

  setStatus("Get ready...");
  await wait(250);
  await advanceRound();
}

/* Toys list */
function renderAllToys(){
  sortShopItems();
  dedupePrizesOwned();
  els.allToysGrid.innerHTML = "";
  for (const item of SHOP_ITEMS){
    const owned = prizesOwned.includes(item.id);
    const c = document.createElement("div");
    c.className = "toyMini";
    c.innerHTML = `
      <div class="toyMiniEmoji">${item.emoji}</div>
      <div class="toyMiniMid">
        <div class="toyMiniName">${item.name}${owned ? " âœ…" : ""}</div>
        <div class="toyMiniDesc">${item.cost} ðŸŽŸï¸ â€¢ ${item.desc}</div>
      </div>
    `;
    els.allToysGrid.appendChild(c);
  }
}

/* Shop */
function openShop(){
  dedupePrizesOwned();
  els.shopTickets.textContent = String(tickets);
  els.prizeCount.textContent = String(prizesOwned.length);
  els.shopBest.textContent = String(best);
  renderShopItems();
  els.shopModal.classList.remove("hidden");
}
function closeShop(){ els.shopModal.classList.add("hidden"); }

/* End = wipe */
function hardResetAllProgress(){
  prizesOwned = [];
  best = 0;
  tickets = 0;
  localStorage.removeItem("mcw_prizes_owned_carnival");
  localStorage.removeItem("mcw_best_carnival");
  updateHUD();
}
function goHomeEnd(){
  closeShop();
  hardResetAllProgress();
  showWelcome();
  resetCoinUI();
}

/* End Screen */
function openEndCongrats(){
  stopBackgroundMusic();
  dedupePrizesOwned();

  els.endTickets.textContent = String(tickets);
  els.endPrizeCount.textContent = String(prizesOwned.length);
  els.endBest.textContent = String(best);

  const ownedItems = prizesOwned
    .map(id => SHOP_ITEMS.find(x => x.id === id))
    .filter(Boolean);

  els.endToysGrid.classList.remove("singleCenter");

  if (ownedItems.length){
    els.endTitle.className = "endTitle congrats";
    els.endTitle.innerHTML = `<span class="rainbowCongrats">Congratulations!</span>`;
    els.endSub.textContent = "Here are the prizes you collected ðŸŽ‰";
    els.endPlayAgainBtn.classList.add("hiddenBtn");
  } else {
    els.endTitle.className = "endTitle lucky";
    els.endTitle.innerHTML = `
      <span style="color: rgba(255,120,220,.95)">Better</span>
      <span style="color: rgba(120,255,240,.95)">Luck</span>
      <span style="color: rgba(255,220,150,.95)">Next</span>
      <span style="color: rgba(170,255,120,.95)">Time!</span>
    `;
    els.endSub.textContent = "No prize this time â€” try again and win tickets! ðŸŽŸï¸";
    els.endToysGrid.classList.add("singleCenter");
    els.endPlayAgainBtn.classList.remove("hiddenBtn");
  }

  els.endToysGrid.innerHTML = "";
  if (ownedItems.length){
    for (const it of ownedItems){
      const c = document.createElement("div");
      c.className = "endToy";
      c.innerHTML = `<div class="e">${it.emoji}</div><div class="n">${it.name}</div>`;
      els.endToysGrid.appendChild(c);
    }
  } else {
    const c = document.createElement("div");
    c.className = "endToy";
    c.innerHTML = `<div class="e">ðŸŽ¡</div><div class="n">Play again to collect prizes!</div>`;
    els.endToysGrid.appendChild(c);
  }

  els.endCongratsModal.classList.remove("hidden");
  if (ownedItems.length){
    confettiBurst(window.innerWidth * 0.5, window.innerHeight * 0.35, 180, 4.8);
  }
}
function closeEndCongrats(){ els.endCongratsModal.classList.add("hidden"); }

async function playAgainFromEnd(){
  closeEndCongrats();
  closeShop();
  hideWelcome();
  await startNewGame({ resetTickets: false });
}

/* Continue from shop */
async function continueFromShop(){
  closeShop();
  await startNewGame({ resetTickets: false });
}

/* Prize fly animation */
function animatePrizeFly({ fromRect, toRect, emoji }){
  const el = document.createElement("div");
  el.textContent = emoji;
  el.style.position = "fixed";
  el.style.left = `${fromRect.left + fromRect.width/2}px`;
  el.style.top = `${fromRect.top + fromRect.height/2}px`;
  el.style.transform = "translate(-50%,-50%) scale(1)";
  el.style.fontSize = "40px";
  el.style.filter = "drop-shadow(0 14px 16px rgba(0,0,0,.28))";
  el.style.willChange = "transform,left,top,opacity";
  els.fxLayer.appendChild(el);

  const x0 = fromRect.left + fromRect.width/2;
  const y0 = fromRect.top + fromRect.height/2;
  const x1 = toRect.left + toRect.width/2;
  const y1 = toRect.top + toRect.height/2;

  const ctrlX = (x0 + x1) / 2 + (Math.random() * 80 - 40);
  const ctrlY = Math.min(y0, y1) - (90 + Math.random()*60);

  const dur = 520;
  const tStart = performance.now();

  function bezier(t, p0, p1, p2){
    const a = (1-t)*(1-t);
    const b = 2*(1-t)*t;
    const c = t*t;
    return a*p0 + b*p1 + c*p2;
  }
  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

  const step = (now) => {
    const raw = (now - tStart) / dur;
    const t = clamp(raw, 0, 1);
    const e = easeOutCubic(t);
    const x = bezier(e, x0, ctrlX, x1);
    const y = bezier(e, y0, ctrlY, y1);
    el.style.left = `${x}px`;
    el.style.top = `${y}px`;
    const s = 1 - e * 0.55;
    el.style.transform = `translate(-50%,-50%) scale(${s})`;
    el.style.opacity = String(1 - e * 0.15);

    if (t < 1){
      requestAnimationFrame(step);
    } else {
      el.remove();
      confettiBurst(x1, y1, 90, 4.0);
    }
  };
  requestAnimationFrame(step);
}

function renderShopItems(){
  sortShopItems();
  dedupePrizesOwned();
  els.shopItems.innerHTML = "";

  for (const item of SHOP_ITEMS){
    const owned = prizesOwned.includes(item.id);

    const card = document.createElement("div");
    card.className = "shopItem";

    const name = document.createElement("div");
    name.className = "shopName";
    name.innerHTML = `<span class="shopEmoji">${item.emoji}</span> <span>${item.name}</span>`;

    const desc = document.createElement("div");
    desc.className = "shopDesc";
    desc.textContent = item.desc;

    const row = document.createElement("div");
    row.className = "shopBuyRow";

    const cost = document.createElement("div");
    cost.className = "shopCost";
    cost.textContent = `Cost: ${item.cost} tickets`;

    const btn = document.createElement("button");
    btn.className = "btn primary";
    btn.type = "button";

    btn.textContent = owned ? "Owned" : (tickets < item.cost ? "Need tickets" : "Buy");
    btn.disabled = owned || tickets < item.cost;

    btn.addEventListener("pointerdown", async (e) => {
      e.preventDefault();
      ensureAudio();
      dedupePrizesOwned();

      if (prizesOwned.includes(item.id)) return;
      if (tickets < item.cost) return;

      tickets -= item.cost;
      prizesOwned.push(item.id);
      dedupePrizesOwned();
      sfxBell();

      updateHUD();
      renderShopItems();

      const fromRect = btn.getBoundingClientRect();
      const toRect = els.ownedCount.getBoundingClientRect();
      animatePrizeFly({ fromRect, toRect, emoji: item.emoji });
      confettiBurst(fromRect.left + fromRect.width/2, fromRect.top + fromRect.height/2, 110, 4.2);

      setStatus(`Purchased: ${item.name} âœ…`);
      await showBigMessage({ title: "PURCHASED!", sub: `${item.emoji} ${item.name}\nTickets left: ${tickets}`, ms: 850 });
    });

    row.appendChild(cost);
    row.appendChild(btn);

    card.appendChild(name);
    card.appendChild(desc);
    card.appendChild(row);

    els.shopItems.appendChild(card);
  }

  els.shopTickets.textContent = String(tickets);
  els.prizeCount.textContent = String(prizesOwned.length);
  els.shopBest.textContent = String(best);
}

/* HUD */
function updateHUD(){
  els.roundEl.textContent = String(round);
  els.bestEl.textContent = String(best);
  els.ticketsEl.textContent = String(tickets);
  els.ticketsChip.textContent = String(tickets);
  els.prizesEl.textContent = String(prizesOwned.length);
  els.ownedCount.textContent = String(prizesOwned.length);
  renderAllToys();
}

/* Audio */
function ensureAudio(){
  if (!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    master = audioCtx.createGain();
    master.gain.value = 0.25;
    master.connect(audioCtx.destination);

    // separate music bus so we can mute or swap easily
    musicGain = audioCtx.createGain();
    musicGain.gain.value = 1.0;
    musicGain.connect(master);
  }
  if (audioCtx.state === "suspended") audioCtx.resume();
}
function tone(freq, t0, dur, type="sine", gain=0.25){
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.setValueAtTime(freq, t0);
  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
  o.connect(g).connect(master);
  o.start(t0);
  o.stop(t0 + dur + 0.02);
}
function sfxCoin(){
  const t = audioCtx.currentTime;
  tone(220, t, 0.10, "triangle", 0.18);
  tone(440, t + 0.06, 0.12, "triangle", 0.18);
  tone(660, t + 0.12, 0.10, "triangle", 0.14);
}
function sfxBell(){
  const t = audioCtx.currentTime;
  tone(880, t, 0.08, "sine", 0.16);
  tone(1320, t + 0.02, 0.10, "sine", 0.12);
  tone(1760, t + 0.04, 0.10, "sine", 0.10);
}
function sfxCheer(){
  const t = audioCtx.currentTime;
  tone(330, t, 0.18, "sawtooth", 0.08);
  tone(392, t + 0.05, 0.22, "sawtooth", 0.08);
  tone(523, t + 0.10, 0.25, "sawtooth", 0.08);
  tone(659, t + 0.16, 0.22, "sawtooth", 0.06);
}
function sfxBuzzer(){
  const t = audioCtx.currentTime;
  tone(110, t, 0.25, "square", 0.12);
  tone(92, t + 0.12, 0.30, "square", 0.10);
}

// Round advance SFX â€” short ascending arpeggio (bright, non-distracting)
function sfxRoundAdvance(){
  const t = audioCtx.currentTime;
  // three quick notes (A4, C5, E5)
  tone(440, t, 0.06, "sine", 0.06);
  tone(523.25, t + 0.06, 0.06, "triangle", 0.05);
  tone(659.25, t + 0.12, 0.10, "sine", 0.05);
}

// Game over SFX â€” descending 'sad' motif, layered with a buzzer feel
function sfxGameOver(){
  const t = audioCtx.currentTime;
  tone(196, t, 0.20, "square", 0.14);
  tone(164.81, t + 0.18, 0.28, "square", 0.10);
  tone(110, t + 0.40, 0.30, "square", 0.08);
}

// Click SFX for UI buttons
function sfxClick(){
  const t = audioCtx.currentTime;
  tone(1800, t, 0.03, "square", 0.06);
  tone(1200, t + 0.01, 0.06, "sine", 0.04);
}

// Background music (light ambient synth + arpeggio)
let bgOsc1 = null;
let bgOsc2 = null;
let bgArpInterval = null;
let bgGain = null;
let bgPlaying = false;

// Music / external audio support
let musicGain = null;          // music bus connect point
let extAudio = null;          // HTMLAudioElement for external file
let extSource = null;         // MediaElementSourceNode
let extObjectUrl = null;      // object URL to revoke
let extAvailable = false;     // whether an external file exists
let musicMuted = false;       // music mute state
let prevMusicGain = 1.0;      // store previous music gain

function startBGM(){
  // Arcade-style, clean BGM: tight square arpeggio + bass pulse; no ambient pads or noisy textures
  if (bgPlaying) return;
  bgPlaying = true;
  if (!audioCtx) return; // safety

  // music gain for BGM
  bgGain = audioCtx.createGain();
  bgGain.gain.value = 0.22;
  bgGain.connect(musicGain);

  // Clean arcade arpeggio + bass pulse using short, percussive envelopes
  const arpNotes = [880, 1046.5, 1318.5, 1760]; // A5, C6, E6, A6 (bright arcade register)
  let idx = 0;
  let step = 0;
  const bpm = 132; // arcade-leaning tempo
  const stepMs = (60000 / bpm) / 2; // 8th-note stepping

  // interval triggers short tone() calls (no sustained pads)
  bgArpInterval = setInterval(() => {
    const tNow = audioCtx.currentTime;

    // Bass pulse on downbeats (every 4 steps)
    if (step % 4 === 0){
      // punchy bass via tone helper
      tone(110, tNow, 0.14, "square", 0.16);
    }

    // Main arpeggio note (short square) - prominent, but not noisy
    const f = arpNotes[idx % arpNotes.length];
    // Use square for retro feeling, short duration and modest gain
    tone(f, tNow + 0.002, 0.12, "square", 0.08);

    // small octave hop every other cycle to add motion
    if (step % 8 === 6){
      tone(f * 2, tNow + 0.02, 0.08, "square", 0.05);
    }

    idx++;
    step++;
  }, stepMs);
}

function stopBGM(){
  if (!bgPlaying) return;
  bgPlaying = false;
  if (bgArpInterval){ clearInterval(bgArpInterval); bgArpInterval = null; }
  if (bgOsc1){
    if (bgOsc1._lfo){ try{ bgOsc1._lfo.stop(); }catch(e){} bgOsc1._lfo.disconnect(); delete bgOsc1._lfo; }
    try{ bgOsc1.stop(); }catch(e){}
    try{ bgOsc1.disconnect(); }catch(e){}
    bgOsc1 = null;
  }
  if (bgOsc2){ try{ bgOsc2.stop(); }catch(e){} try{ bgOsc2.disconnect(); }catch(e){} bgOsc2 = null; }
  if (bgGain){ try{ bgGain.disconnect(); }catch(e){} bgGain = null; }
}

// External audio: load and play an uploaded looped file
function loadExternalBGM(file){
  if (!file) return;
  ensureAudio();

  // stop and clean previous
  if (extAudio){ stopExternalBGM(); if (extObjectUrl){ URL.revokeObjectURL(extObjectUrl); extObjectUrl = null; } }

  extObjectUrl = URL.createObjectURL(file);
  extAudio = new Audio(extObjectUrl);
  extAudio.loop = true;
  extAudio.crossOrigin = 'anonymous';
  extAudio.preload = 'auto';

  try{
    extSource = audioCtx.createMediaElementSource(extAudio);
    extSource.connect(musicGain);
    extAvailable = true;
    // start playback (user gesture already in file select)
    extAudio.play().catch(()=>{});
  }catch(e){
    // Fallback: if audioCtx cannot attach, mark unavailable
    extAvailable = false;
  }
}

function playExternalBGM(){
  if (!extAudio) return;
  ensureAudio();
  // stop synth if running
  stopBGM();
  extAudio.play().catch(()=>{});
}
function stopExternalBGM(){
  if (!extAudio) return;
  try{ extAudio.pause(); }catch(e){}
  try{ extSource && extSource.disconnect(); }catch(e){}
  extSource = null;
}

function startBackgroundMusic(){
  ensureAudio();
  if (extAvailable && extAudio){
    playExternalBGM();
  } else {
    startBGM();
  }
}
function stopBackgroundMusic(){
  stopExternalBGM();
  stopBGM();
}

function toggleMusicMute(){
  if (!musicGain) return;
  if (!audioCtx) ensureAudio();
  musicMuted = !musicMuted;
  const btn = document.getElementById('musicToggleSideBtn');
  if (musicMuted){
    // smooth ramp to 0
    prevMusicGain = musicGain.gain.value || prevMusicGain;
    musicGain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.04);
    if (btn) btn.textContent = 'Music: Off';
  } else {
    musicGain.gain.exponentialRampToValueAtTime(prevMusicGain, audioCtx.currentTime + 0.04);
    if (btn) btn.textContent = 'Music: On';
  }
}

/* Coin drag-to-insert */
let dragging = false;
let ghost = null;
function rectsOverlap(a, b){
  return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom);
}
function setCoinInsertedState(on){
  coinInserted = on;
  els.coinSlotState.textContent = on ? "COIN INSERTED" : "NO COIN";
  els.startBtn.disabled = !on;
  els.startBtn.textContent = "Start Game";
}
function resetCoinUI(){
  if (ghost){ ghost.remove(); ghost = null; }
  dragging = false;
  els.coin.style.visibility = "visible";
  els.coinSlot.classList.remove("inserting");
  setCoinInsertedState(false);
}
function animateCoinIntoSlot(slotRect){
  if (!ghost) return;
  els.coinSlot.classList.add("inserting");

  const slitX = slotRect.left + slotRect.width / 2;
  const slitY = slotRect.top + slotRect.height * 0.46;

  ghost.classList.add("coinDrop");
  ghost.style.left = `${slitX}px`;
  ghost.style.top = `${slitY}px`;

  setTimeout(() => {
    if (!ghost) return;
    requestAnimationFrame(() => {
      ghost.style.top = `${slitY + 26}px`;
      ghost.style.transform = "translate(-50%,-50%) scale(0.10)";
      ghost.style.opacity = "0";
      ghost.style.filter = "blur(1.2px)";
    });
  }, 120);

  setTimeout(() => {
    if (ghost){ ghost.remove(); ghost = null; }
    els.coin.style.visibility = "hidden";
    els.coinSlot.classList.remove("inserting");
    setCoinInsertedState(true);
    setStatus("Coin accepted. Press Start Game.");
    ensureAudio(); sfxCoin();
    const r = els.coinSlot.getBoundingClientRect();
    confettiBurst(r.left + r.width/2, r.top + r.height/2, 70, 3.8);
  }, 480);
}
function onCoinPointerDown(e){
  if (coinInserted) return;
  e.preventDefault();
  dragging = true;

  ghost = els.coin.cloneNode(true);
  ghost.classList.add("coinGhost");
  ghost.removeAttribute("id");
  document.body.appendChild(ghost);

  els.coin.style.visibility = "hidden";

  const move = (ev) => {
    if (!dragging || !ghost) return;
    ghost.style.left = `${ev.clientX}px`;
    ghost.style.top = `${ev.clientY}px`;
  };
  const up = (ev) => {
    if (!dragging) return;
    dragging = false;

    if (ghost){
      ghost.style.left = `${ev.clientX}px`;
      ghost.style.top = `${ev.clientY}px`;

      const coinRect = ghost.getBoundingClientRect();
      const slotRect = els.coinSlot.getBoundingClientRect();

      window.removeEventListener("pointermove", move);
      window.removeEventListener("pointerup", up);
      window.removeEventListener("pointercancel", up);

      if (rectsOverlap(coinRect, slotRect)){
        animateCoinIntoSlot(slotRect);
      } else {
        ghost.remove();
        ghost = null;
        els.coin.style.visibility = "visible";
      }
    }
  };

  window.addEventListener("pointermove", move, { passive: false });
  window.addEventListener("pointerup", up, { passive: false });
  window.addEventListener("pointercancel", up, { passive: false });
}

/* Confetti */
const conf = { ctx: null, w: 0, h: 0, running: false, parts: [] };
function resizeConfettiCanvas(){
  const dpr = window.devicePixelRatio || 1;
  conf.w = window.innerWidth;
  conf.h = window.innerHeight;
  els.confetti.width = Math.floor(conf.w * dpr);
  els.confetti.height = Math.floor(conf.h * dpr);
  els.confetti.style.width = conf.w + "px";
  els.confetti.style.height = conf.h + "px";
  conf.ctx = els.confetti.getContext("2d");
  conf.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
function confettiBurst(x, y, count=120, power=4.2){
  const colors = SLICE_COLORS;
  for (let i=0; i<count; i++){
    const a = Math.random() * Math.PI * 2;
    const sp = (Math.random() * 0.85 + 0.15) * (power * 2.6);
    conf.parts.push({
      x, y,
      vx: Math.cos(a) * sp + (Math.random()*1.2 - 0.6),
      vy: Math.sin(a) * sp - (power * 1.3),
      g: 0.14 + Math.random()*0.12,
      r: Math.random()*Math.PI*2,
      vr: (Math.random()*0.25 - 0.125),
      w: 3 + Math.random()*5,
      h: 6 + Math.random()*10,
      life: 52 + Math.floor(Math.random()*30),
      color: colors[(Math.random()*colors.length)|0],
      alpha: 1
    });
  }
  if (!conf.running) runConfetti();
}
function runConfetti(){
  conf.running = true;
  const tick = () => {
    const ctx = conf.ctx;
    if (!ctx){ conf.running = false; return; }
    ctx.clearRect(0,0,conf.w,conf.h);

    for (let i=conf.parts.length-1; i>=0; i--){
      const p = conf.parts[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += p.g;
      p.r += p.vr;
      p.life -= 1;
      p.alpha = clamp(p.life / 60, 0, 1);

      ctx.save();
      ctx.globalAlpha = p.alpha;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.r);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();

      if (p.life <= 0 || p.y > conf.h + 80){
        conf.parts.splice(i, 1);
      }
    }

    if (conf.parts.length){
      requestAnimationFrame(tick);
    } else {
      conf.running = false;
      ctx.clearRect(0,0,conf.w,conf.h);
    }
  };
  requestAnimationFrame(tick);
}

/* Events */
els.welcomeNextBtn.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  showInstructionsPage();
  const r = els.welcomeNextBtn.getBoundingClientRect();
  confettiBurst(r.left + r.width/2, r.top + r.height/2, 95, 4.0);
});
els.welcomeBackBtn.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  showWelcomePage();
});

els.startBtn.addEventListener("pointerdown", async (e) => {
  e.preventDefault();
  if (!coinInserted) return;
  hideWelcome();
  await startNewGame({ resetTickets: true });
});

els.backToHomeBtn.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  closeShop();
  openEndCongrats();
});

els.endPlayAgainBtn.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  playAgainFromEnd();
});

els.endBackToWelcomeBtn.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  closeEndCongrats();
  goHomeEnd();
});

els.shopContinueBtn.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  continueFromShop();
});

els.coin.addEventListener("pointerdown", onCoinPointerDown, { passive: false });

els.wheelSvg.addEventListener("pointerdown", (e) => {
  const target = e.target;
  if (!(target instanceof SVGPathElement)) return;
  if (!target.classList.contains("slice")) return;
  e.preventDefault();
  onPlayerPick(Number(target.dataset.slice));
}, { passive: false });

// play small click SFX when pressing buttons/interactive elements
window.addEventListener('pointerdown', (e) => {
  const el = e.target;
  const btn = el.closest('button, [role="button"], .bonusBtn, .coin');
  if (btn){
    ensureAudio();
    sfxClick();
  }
}, { passive: false });

// Music control UI handlers
const _musicToggle = document.getElementById('musicToggleSideBtn');
const _musicSlider = document.getElementById('musicVolume');
const _musicVolLabel = document.getElementById('musicVolLabel');

_musicToggle && _musicToggle.addEventListener('click', (e) => { e.preventDefault(); ensureAudio(); toggleMusicMute(); });

if (_musicSlider){
  // initialize slider to current music gain or stored previous
  try{
    const current = (musicGain && musicGain.gain && typeof musicGain.gain.value === 'number') ? musicGain.gain.value : prevMusicGain;
    _musicSlider.value = String(current);
    _musicVolLabel && (_musicVolLabel.textContent = Math.round(Number(_musicSlider.value) * 100) + '%');
    // if starts at 0, reflect off state
    if (Number(_musicSlider.value) === 0){ musicMuted = true; const btn = document.getElementById('musicToggleSideBtn'); if (btn) btn.textContent = 'Music: Off'; }
  }catch(e){ }

  _musicSlider.addEventListener('input', (ev) => {
    ensureAudio();
    const v = Number(ev.target.value);
    prevMusicGain = v;
    _musicVolLabel && (_musicVolLabel.textContent = Math.round(v * 100) + '%');
    if (musicGain){
      musicGain.gain.setValueAtTime(v, audioCtx.currentTime + 0.01);
    }
    // slider acts as on/off: if zero, set off state
    const btn = document.getElementById('musicToggleSideBtn');
    if (v === 0){ musicMuted = true; if (btn) btn.textContent = 'Music: Off'; } else { musicMuted = false; if (btn) btn.textContent = 'Music: On'; }
  });

  // clicking the label toggles between 0 and previous value
  _musicVolLabel.addEventListener('click', (ev) => {
    ensureAudio();
    const btn = document.getElementById('musicToggleSideBtn');
    if (musicMuted || Number(_musicSlider.value) === 0){
      // turn on
      const v = prevMusicGain || 1.0;
      _musicSlider.value = String(v);
      _musicVolLabel.textContent = Math.round(v * 100) + '%';
      if (musicGain) musicGain.gain.setValueAtTime(v, audioCtx.currentTime + 0.01);
      musicMuted = false; if (btn) btn.textContent = 'Music: On';
    } else {
      // turn off
      prevMusicGain = Number(_musicSlider.value) || prevMusicGain || 1.0;
      _musicSlider.value = '0';
      _musicVolLabel.textContent = '0%';
      if (musicGain) musicGain.gain.setValueAtTime(0.0001, audioCtx.currentTime + 0.01);
      musicMuted = true; if (btn) btn.textContent = 'Music: Off';
    }
  });
}

/* Init */
function init(){
  resizeConfettiCanvas();
  buildStars();
  buildEndTwinkles();
  buildFlags();
  buildTwinkles();
  buildSparkles();
  spawnBackgroundBalloons();
  buildWheelLights();
  buildSegments();
  renderWheel();
  setHourglass(1);
  updateHUD();
  resetCoinUI();
  clearBonusBalloons();
  showWelcome();

  requestAnimationFrame(() => {
    applyAppScale();
    requestAnimationFrame(applyAppScale);
  });
}
init();
  </script>
</body>
</html>
